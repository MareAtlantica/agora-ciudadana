void 0===window.gettext&&(window.gettext=function(text){return text}),void 0===window.escapeAttribute&&(window.escapeAttribute=function(text){return text&&text.replace?text.replace(/[^0-9a-zA-Z ]+/gi,""):text}),function(){var Agora=this.Agora={},app=this.app={};Agora.TopView=Backbone.View.extend({el:"#top-bar",events:{},initialize:function(){_.bindAll(this)}}),Agora.MainView=Backbone.View.extend({el:"body",events:{"click a.action-form-link":"onActionFormLinkClicked"},initialize:function(){_.bindAll(this),$(document).ajaxStop(this.updateUi),this.updateUi(),this.setMomentLang(),this.topBar=new Agora.TopView},updateUi:function(){},setMomentLang:function(){moment.lang(this.$el.data("lang"))},onActionFormLinkClicked:function(event){event.preventDefault();var target=$(event.currentTarget);this.$("#post-action-form").attr("action",target.attr("href")),this.$("#post-action-form").submit()}}),app.main=new Agora.MainView,Agora.MessagesBox=Backbone.View.extend({el:"#messages-box",initialize:function(){var modal=this.$(".modal");modal.length>0&&this.$(".modal").modal("show")}}),app.messages=new Agora.MessagesBox,Agora.round2decimals=function(num){return Math.round(100*num)/100}}.call(this);var Ajax=Backbone.View.extend({initialize:function(){_.bindAll(this)},setContext:function(ctx){this.ctx=ctx},get:function(url,data,type){return this.request("GET",url,data,type)},post:function(url,data,type){return this.request("POST",url,data,type)},put:function(url,data,type){return this.request("PUT",url,data,type)},"delete":function(url,data,type){return this.request("DELETE",url,data,type)},request:function(type,url,data,dataType){var ajax_data={url:url,dataType:dataType||"text",type:type};return void 0!==data&&(ajax_data.data=data),this.options.contentType&&(ajax_data.contentType=this.options.contentType),this.options.headers&&(ajax_data.headers=this.options.headers),ajax_data.complete=this.requestComplete,$.ajax(ajax_data)},requestComplete:function(jxhr,stat){this.trigger("success",jxhr,stat,this.ctx)}});$.ajaxSetup({beforeSend:function(xhr,settings){function getCookie(name){var cookieValue=null;if(document.cookie&&""!=document.cookie)for(var cookies=document.cookie.split(";"),i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}return cookieValue}/^http:.*/.test(settings.url)||/^https:.*/.test(settings.url)||xhr.setRequestHeader("X-CSRFToken",getCookie("csrftoken"))}}),function(){var Charts=this.Charts={};Charts.grad=Math.PI/180,Charts.arc=function(data,node,selector,key_selector,color,width,height){function sweep(a){var i=d3.interpolate({startAngle:-90*Charts.grad,endAngle:-90*Charts.grad},a);return function(t){return arc(i(t))}}var radius=Math.min(width,height),pie=d3.layout.pie().sort(null).value(function(d){return selector(d)}).startAngle(-90*Charts.grad).endAngle(90*Charts.grad),arc=d3.svg.arc().innerRadius(radius-150).outerRadius(radius-40),arc2=d3.svg.arc().innerRadius(radius-150).outerRadius(radius-5),svg=d3.select(node).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height+")"),g=svg.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc");g.append("path").attr("d",arc).attr("fill",function(d,i){return color(i)}).transition().duration(2e3).each("end",function(){d3.select(this).on("mouseover",Charts._arc_mouseover(this,arc2,svg,key_selector)).on("mouseout",Charts._arc_mouseout(this,arc))}).attrTween("d",sweep)},Charts._arc_mouseover=function(o,arc2,svg,key_selector){var obj=d3.select(o),key=key_selector(obj.data()[0].data);key.length>=35&&(key=key.slice(0,35)+"...");{var val=obj.data()[0].value;svg.attr("width"),svg.attr("height")}return function(){obj.transition().attr("d",arc2).duration(200),svg.select("g").append("text").attr("class","textg").attr("dy","-3em").attr("text-anchor","middle").style("font","300 24px Sans Serif").text(key),svg.select("g").append("text").attr("class","textg").attr("dy","-1em").attr("text-anchor","middle").style("font","700 24px Sans Serif").text(val)}},Charts._arc_mouseout=function(o,arc){var obj=d3.select(o);return function(){obj.transition().attr("d",arc).duration(500),d3.selectAll(".textg").remove()}}}.call(this),function(){var Agora=this.Agora,app=this.app;(function(){var ElectionModel=Backbone.Model.extend({}),ElectionsCollection=Backbone.Collection.extend({model:ElectionModel});Agora.CalendarWidgetView=Backbone.View.extend({el:"#agora-calendar",events:{"keyup .election-search-query":"onSearchChange"},initialize:function(){_.bindAll(this),this.template=_.template($("#template-calendar-election-item-view").html()),this.calendarTemplate=_.template($("#template-calendar-view").html());var calTmplData={open_elections:user_data.open_elections,agoras:user_data.agoras};this.$el.html(this.calendarTemplate(calTmplData)),this.collection=new ElectionsCollection,this.collection.on("reset",this.resetCollection);var ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url")),this.onSearchChange=_.debounce(this.onSearchChange,400)},initializeSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);this.collection.reset(data.objects)}},onSearchChange:function(event){var target=$(event.currentTarget),data={q:target.val()},ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url"),data),console.log("onSearchChange: "+target.val())},resetCollection:function(collection){this.$(".list-container").empty();var data=collection.groupBy(function(item){var date=item.get("voting_extended_until_date")||item.get("voting_ends_at_date")||item.get("voting_starts_at_date");return date?date.split("T")[0]:null});_.each(_.pairs(data),function(item){var key=item[0],val=item[1],date=moment(key),dom=this.template({datetime:date.format("LL"),items:val});this.$(".list-container").append(dom)},this),0===collection.length&&this.$(".list-container").append(this.$("#no-elections"))}})}).call(this),function(){var AgoraModel=Backbone.Model.extend({}),AgorasCollection=Backbone.Collection.extend({model:AgoraModel});Agora.AgoraWidgetListView=Backbone.View.extend({el:"#agora-list",initialize:function(){_.bindAll(this),this.agoraTemplate=_.template($("#template-agora").html()),this.agorasCollection=new AgorasCollection,this.agorasCollection.on("reset",this.resetAgorasCollection);var ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url"))},initializeSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);this.agorasCollection.reset(data.objects)}},resetAgorasCollection:function(collection){if(this.$(".last-agoras .list-container").empty(),0===collection.length){var emptyItem=this.make("ul",{id:"no-agoras"},gettext("No agoras found"));this.$(".last-agoras .list-container").append(emptyItem)}else collection.each(this.addAgoraItem)},addAgoraItem:function(model){var dom=this.agoraTemplate(model.toJSON());this.$(".last-agoras .list-container").append(dom)}})}.call(this),function(){Agora.ModalDialogView=Backbone.View.extend({el:"#modaldialogdiv",initialize:function(){_.bindAll(this),this.template=_.template($("#template-modal_dialog").html()),this.delegateEvents()},populate:function(header,body,footer){this.$el.html(this.template({header:header,body:body,footer:footer})),this.delegateEvents()},modal:function(data){this.$el.find("#modal_dialog").modal(data)},hide:function(){this.modal("hide")},show:function(){this.modal("show")}})}.call(this),Agora.delegateVoteHandler=function(e,self){if(!self.sendingData){var agora=$(e.target).data("agora"),delegate=$(e.target).data("delegate"),ballot={action:"delegate_vote",user_id:delegate.id},data={agora:agora,delegate:delegate};app.confirmDelegateActionDialog=new Agora.ModalDialogView;var title=interpolate(gettext("Confirm delegation to %s in agora %s"),[delegate.full_name,agora.full_name]),body=_.template($("#template-confirm_delegate_modal_dialog_body").html())(data),footer=_.template($("#template-confirm_delegate_modal_dialog_footer").html())();app.confirmDelegateActionDialog.populate(title,body,footer),app.confirmDelegateActionDialog.show(),self.sendingData=!0,$("#confirm-delegate-action").click(function(e){if(e.preventDefault(),$("#confirm-delegate-action").hasClass("disabled"))return!1;$("#confirm-delegate-action").addClass("disabled");$.ajax("/api/v1/agora/"+agora.id+"/action/",{data:JSON.stringifyCompat(ballot),contentType:"application/json",type:"POST"}).done(function(e,self){return self.sendingData=!1,$("#modal_dialog").modal("hide"),!1}).fail(function(){return $("#confirm-delegate-action").removeClass("disabled"),alert("Error casting the ballot, try again or report this problem"),$("#modal_dialog").modal("hide"),!1});return!1}),$("#deny-delegate-action").click(function(){return $("#modal_dialog").modal("hide"),!1}),self.sendingData=!1}},function(){var ItemModel=Backbone.Model.extend({}),ItemCollection=Backbone.Collection.extend({model:ItemModel});Agora.GenericListView=Backbone.View.extend({el:"#activity-list",events:{"click a.endless_more":"onMoreClicked"},setup:function(){this.url=this.$el.data("url"),this.method=this.$el.data("method")||"get"},setupTemplates:function(){void 0!==this.templateEl&&(this.template=_.template($(this.templateEl).html()))},initialize:function(){_.bindAll(this),this.firstLoadSuccess=!1,this.finished=!1,this.collection=new ItemCollection,this.collection.on("reset",this.collectionReset),this.collection.on("add",this.addItem),this.endlessDom=this.$(".endless-container"),this.endlessDom.find("div.endless_loading").hide(),this.offset=0,this.limit=20,this.setup(),this.setupTemplates(),this.delegateEvents(),this.requestObjects(),$(window).scroll(this.infiniteScroll)},requestObjects:function(){if(!this.finished){var ajax=new Ajax;ajax.on("success",this.requestSuccess);var params=_.extend({},{limit:this.limit,offset:this.offset},this.params||{});this.offset+=this.limit,"get"===this.method?ajax.get(this.url,params):"post"===this.method&&ajax.post(this.url,params)}},setEndlessFinishDom:function(){this.endlessDom.find("a.endless_more").replaceWith(gettext("<span>No more results</span>")),this.endlessDom.find("div.endless_loading").hide()},requestSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);if(this.endlessDom.find("div.endless_loading").hide(),0===data.objects.length)this.setEndlessFinishDom(),this.finished=!0;else{var doc=$(document),win=$(window);this.firstLoadSuccess?(this.$("a.endless_more").show(),_.each(data.objects,function(item){this.collection.add(item)},this)):(this.firstLoadSuccess=!0,this.collection.reset(data.objects)),this.endlessDom.appendTo(this.$el),data.objects.length<this.limit?(this.setEndlessFinishDom(),this.finished=!0):doc.height()==win.height()&&0==win.scrollTop()&&(this.onMoreClicked(),this.$("a.endless_more").hide(),this.endlessDom.find("div.endless_loading").show())}}},collectionReset:function(collection){this.$el.empty(),collection.each(this.addItem)},renderItem:function(model){return void 0!==this.template?this.template(model.toJSON()):"<div>REIMPLEMENT THIS</div>"},addItem:function(model){var html=this.renderItem(model);this.$el.append(html)},infiniteScroll:function(){var doc=$(document),win=$(window),margin=this.$el.data("margin")||300;!this.finished&&doc.height()-win.height()-win.scrollTop()<=margin&&(this.onMoreClicked(),this.$("a.endless_more").hide(),this.endlessDom.find("div.endless_loading").show())},onMoreClicked:function(event){event&&event.preventDefault(),this.requestObjects()}}),Agora.ActivityListView=Agora.GenericListView.extend({el:"#activity-list",setup:function(){this.url=this.$el.data("url"),this.method=this.$el.data("method")||"get",this.templates={}},renderItem:function(model){var json=model.toJSON();return json.actor.initials=Agora.getUserInitials(json.actor),this.templates[json.type_name]||(this.templates[json.type_name]=_.template($("#template-action_"+json.type_name).html()||"<#template-action_"+json.type_name+" not found>")),this.templates[json.type_name](json)}}),Agora.getUserInitials=function(json){if(json.full_name&&json.full_name!=json.username){var initials="",words=$.trim(json.full_name).split(" ");return _.each(words,function(word){var trimmed=$.trim(word);trimmed.length>0&&(initials+=word[0].toUpperCase())}),initials}return json.username[0].toUpperCase()},Agora.ActionListView=Backbone.View.extend({el:"#action_list",events:{"click a.main-action":"doAction","click a.action-link":"doAction"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-action_list").html()),this.setup(),this.render(),this.$el},setup:function(){this.model={}},render:function(){return this.model&&(this.$el.html(this.template(this.model)),this.delegateEvents()),this},doAction:function(e){e.preventDefault(),console.log("doAction not implemented")}})}.call(this)}.call(this),function(){{var Agora=this.Agora;this.app}Agora.HomeActivtyList=Agora.ActivityListView.extend({points:[],collectionReset:function(collection){this.$el.empty(),collection.each(this.addItem),this.slideShowElement="#activity_items",this.DELAY_SPEED=4e3,this.xy=d3.geo.mercator(),this.geopath=d3.geo.path().projection(this.xy),this.states=d3.select("#home_worldmap_canvas").append("svg").append("g").attr("id","states"),this.currentSlide=0,this.slides=$("#activity-list > div"),this.interval=setInterval(this.nextSlide,this.DELAY_SPEED);var self=this;this.slides.each(function(){$(this).appendTo($(self.slideShowElement))}),d3.json("/static/js/world-countries.json",function(collection){self.xy.scale(51);var translate=self.xy.translate();translate[0]=160,translate[1]=110,self.xy.translate(translate),self.states.selectAll("path").data(collection.features).enter().append("path").attr("d",self.geopath),self.slides.each(function(){self.geolocateElement($(this))})})},nextSlide:function(){this.currentSlide>=this.slides.length-1?this.currentSlide=0:this.currentSlide++,$(this.slideShowElement+" > div").first().removeClass("activity-action-first");var newElement=$(this.slides[this.currentSlide]).clone().addClass("activity-action-first").hide();newElement.prependTo($(this.slideShowElement)),newElement.animate({height:"toggle",opacity:"toggle"},"slow"),$(this.slideShowElement+" > div").last().remove(),this.geolocateElement(newElement),null!=this.interval&&clearInterval(this.interval),this.interval=setInterval(this.nextSlide,this.DELAY_SPEED)},geolocateElement:function(element){var geodata=element.attr("geodata");if(geodata.length>0){geodata=geodata.substr(1,geodata.length-2),geodata=geodata.split(",");var pos=[parseFloat(geodata[1]),parseFloat(geodata[0])];this.geolocate(pos)}},geolocate:function(pos){function animateSecondStep(){self.points.push(this)}pos=this.xy(pos);var point=this.points.pop();point&&d3.select(point).transition().duration(100).style("fill-opacity","0").each("end",function(){d3.select(this).remove()});var self=this;d3.select("#home_worldmap_canvas svg").append("svg:circle").style("fill-opacity","0.1").style("fill","red").attr("r",10).attr("cx",pos[0]).attr("cy",pos[1]).transition().delay(0).duration(1e3).attr("r",1.5).style("fill-opacity","1").each("end",animateSecondStep)}}),Agora.HomeAnonymousView=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.HomeActivtyList)}})}.call(this),function(){{var Agora=this.Agora;this.app}Agora.UserAgorasListView=Backbone.View.extend({el:"#user_agora_list",show_other:!1,initialize:function(options){return _.bindAll(this),this.template=_.template($("#template-user_agora_list").html()),options&&options.show_other&&(this.show_other=options.show_other),this.render(),this.$el},render:function(){function agoraChartData(agora){var castvotes=ajax_data.castvotes_by_agoras[agora.id.toString()].objects,abs_values=_.map(castvotes,function(castvote){return{x:new Date(castvote.created_at_date).getTime(),y:castvote.count}});return abs_values=_.sortBy(abs_values,function(item){return item.x}),[{values:abs_values,key:gettext("Delegated votes"),color:"#ff7f0e"}]}var data=JSON.parse(JSON.stringify(ajax_data));this.show_other||(data.user_agoras=user_data.agoras,data.user=user_data.user),this.$el.html(this.template(data)),this.delegateEvents();for(var self=this,i=0;i<data.user_agoras.objects.length;i++)!function(){var agora=data.user_agoras.objects[i],chartDivSelector="#chart-user-agora"+agora.id,agoraData=agoraChartData(agora);0!=agoraData[0].values.length&&nv.addGraph(function(){var chart=nv.models.lineChart();return chart.xAxis.ticks(-1).tickFormat(function(d){return d3.time.format("%d/%m")(new Date(d))}),chart.yAxis.tickFormat(d3.format(",f")),d3.select(chartDivSelector+" svg").datum(agoraData).call(chart),$(chartDivSelector).removeClass("hide"),self.$(".agora-user-item[data-agora-id="+agora.id+"]").removeClass("simple"),self.$(".agora-user-item[data-agora-id="+agora.id+"]").addClass("complex"),chart.update(),chart})}();return this}})}.call(this),function(){{var Agora=this.Agora;this.app}Agora.HomeView=Backbone.View.extend({el:"div.home",initialize:function(){_.bindAll(this),this.calendarView=new Agora.CalendarWidgetView,this.user_agoras_list_view=new Agora.UserAgorasListView,this.activityListView=new Agora.ActivityListView}})}.call(this),function(){var Agora=this.Agora,app=this.app;Agora.TalliedElectionsView=Backbone.View.extend({el:"#tallied_elections_view",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-tallied_elections_view").html()),this.render(),this.$el},render:function(){for(var i=0;i<ajax_data.tallied_elections.objects.length;i++){var election=ajax_data.tallied_elections.objects[i];if(election.result.is_simple=!1,election.result.participation_percentage=Agora.round2decimals(100*election.result.total_votes/election.result.electorate_count),1==election.result.counts.length&&"question/result/ONE_CHOICE"==election.result.counts[0].a)for(var winner=election.result.counts[0].winners[0],answers=election.result.counts[0].answers,j=0;j<answers.length;j++)if(answers[j].value==winner){election.result.winner_data=answers[j],election.result.winner_data.total_count_percentage=Agora.round2decimals(election.result.winner_data.total_count_percentage),election.result.is_simple=!0;break}}return this.$el.html(this.template(ajax_data.tallied_elections)),this.delegateEvents(),this}}),Agora.AgoraActionListView=Agora.ActionListView.extend({sendingData:!1,setup:function(){this.model={dropdown:!1,main_action_class:"btn-success",main_action_icon:"icon-heart icon-white",main_action_name:gettext("Join this agora now"),main_action_id:"join",actions:[]};var userid=$("body").data("userid");(ajax_data.agora.creator.id==userid||_.contains(ajax_data.user_permissions.permissions,"admin")||_.contains(ajax_data.user_permissions.permissions,"leave"))&&(this.model.main_action_icon="icon-cog",this.model.dropdown=!0,this.model.main_action_class="",this.model.main_action_id="",this.model.main_action_name=gettext("Quick actions")),_.contains(ajax_data.user_permissions.permissions,"admin")&&(this.model.actions=this.model.actions.concat([{id:"admin-agora",name:gettext("Edit agora details"),icon:"icon-edit"},{id:"add-members-manually",name:gettext("Add members manually.."),icon:"icon-plus"},{id:"send-email-to-members",name:gettext("Send email to members.."),icon:"icon-envelope"},{id:"remove-my-admin-membership",name:gettext("Remove my admin membership"),icon:"icon-remove"}])),_.contains(ajax_data.user_permissions.permissions,"leave")&&(this.model.actions=this.model.actions.concat([{id:"leave-agora",name:gettext("Leave this agora"),icon:"icon-remove"}])),_.contains(ajax_data.user_permissions.permissions,"request_admin_membership")&&this.model.actions.push({id:"request-admin",name:gettext("Request admin membership"),icon:"icon-eject"}),_.contains(ajax_data.user_permissions.permissions,"cancel_admin_membership_request")&&this.model.actions.push({id:"cancel-admin-request",name:gettext("Cancel admin membership request"),icon:"icon-remove"}),_.contains(ajax_data.user_permissions.permissions,"cancel_vote_delegation")&&this.model.actions.push({id:"cancel-vote-delegation",name:gettext("Cancel vote delegation"),icon:"icon-remove"}),_.contains(ajax_data.user_permissions.permissions,"request_membership")&&(this.model={dropdown:!1,main_action_class:"btn-success",main_action_icon:"icon-heart icon-white",main_action_name:gettext("Request membership in this agora"),main_action_id:"request-membership",actions:[]}),_.contains(ajax_data.user_permissions.permissions,"cancel_membership_request")&&(this.model={dropdown:!1,main_action_class:"",main_action_icon:"icon-remove",main_action_name:gettext("You requested membership"),main_action_id:"cancel-membership-request",actions:[]})},doAction:function(e){if(e.preventDefault(),!this.sendingData){var a=$(e.target).closest("a"),action_id=a.data("id");if(action_id){this.sendingData=!0,a.addClass("disabled");var data=null;switch(action_id){case"admin-agora":return void(window.location.href=ajax_data.agora.url+"/admin");case"add-members-manually":return a.removeClass("disabled"),this.sendingData=!1,void this.addMembersManually();case"send-email-to-members":return a.removeClass("disabled"),this.sendingData=!1,void this.showMailToMembersDialog();case"remove-my-admin-membership":data={action:"leave_admin_membership"};break;case"leave-agora":data={action:"leave"};break;case"request-admin":data={action:"request_admin_membership"};break;case"cancel-admin-request":data={action:"cancel_admin_membership_request"};break;case"join":data={action:"join"};break;case"request-membership":data={action:"request_membership"};break;case"cancel-membership-request":data={action:"cancel_membership_request"};break;case"cancel-vote-delegation":data={action:"cancel_vote_delegation"};break;case"join":data={action:"join"};break;case"request-membership":data={action:"request_membership"};break;default:return void a.removeClass("disabled")}{$.ajax("/api/v1/agora/"+ajax_data.agora.id+"/action/",{data:JSON.stringifyCompat(data),contentType:"application/json",type:"POST"}).done(function(){location.reload()}).fail(function(jqxhr){"join"==action_id&&403==jqxhr.status&&(window.location.href="/accounts/signin/")})}}}},addMembersManually:function(){var title=gettext("Add members manually"),body=_.template($("#template-add_members_modal_dialog_body").html())(),footer=_.template($("#template-add_members_modal_dialog_footer").html())();return app.modalDialog.populate(title,body,footer),app.modalDialog.show(),$("#add-members-action").click(function(e){if(e.preventDefault(),$("#add-members-action").hasClass("disabled"))return!1;var json={agoraid:ajax_data.agora.id,emails:$("#add_members_textarea").val(),welcome_message:gettext("Welcome to this agora")};if(0==json.emails.length)return!1;json.emails=json.emails.split(","),$("#add-members-action").addClass("disabled");$.ajax("/api/v1/user/invite/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(){$("#modal_dialog").modal("hide")}).fail(function(){$("#add-members-action").removeClass("disabled"),alert(gettext("Error sending the invitations, please check the input data"))});return!1}),!1},showMailToMembersDialog:function(){var title=gettext("Send email to agora members"),body=_.template($("#template-mail_to_members_modal_dialog_body").html())(),footer=_.template($("#template-mail_to_members_modal_dialog_footer").html())();return app.modalDialog.populate(title,body,footer),app.modalDialog.show(),$("#send-mail-action").click(function(e){if(e.preventDefault(),$("#send-mail-action").hasClass("disabled"))return!1;var json={action:"mail_to_members",receivers:$("#mail_receivers").val(),subject:$("#mail_subject").val(),body:$("#mail_body").val()};if(0==json.subject.length||0==json.body.length)return!1;$("#send-mail-action").addClass("disabled");{var path="/api/v1/agora/"+ajax_data.agora.id+"/action/";$.ajax(path,{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(){$("#modal_dialog").modal("hide")}).fail(function(){$("#send-mail-action").removeClass("disabled"),alert(gettext("Error sending the mail, please check the input data"))})}return!1}),!1}}),Agora.renderAgoraTabs=function(){var tabsTemplate=_.template($("#template-agora-tabs-view").html());$("#agora-tabs").html(tabsTemplate(ajax_data)),$("#agora-tabs [data-tabname="+current_tab+"]").addClass("active")},Agora.renderAgoraCalendar=function(){var tabsTemplate=_.template($("#template-agora-calendar-view").html());$("#agora-calendar").html(tabsTemplate(ajax_data))},Agora.AgoraView=Backbone.View.extend({el:"div.agora",initialize:function(){_.bindAll(this),this.calendarView=new Agora.CalendarWidgetView,this.agoraActionListView=new Agora.AgoraActionListView,app.modalDialog=new Agora.ModalDialogView,Agora.renderAgoraTabs(),Agora.renderAgoraCalendar();var text=$("#agora_short_description").text(),converter=new Showdown.converter;$("#agora_short_description").html(converter.makeHtml(text)),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView,this.talliedElectionsView=new Agora.TalliedElectionsView),this.social()},social:function(){var name=ajax_data.agora.name,desc=ajax_data.agora.short_description,link=encodeURIComponent(location.href),hr="";hr=$("#twittershare").attr("href"),hr+="?url="+link,hr+="&text="+encodeURIComponent(name+" / "+desc),$("#twittershare").attr("href",hr),$("#twittershare").click(function(){return window.open($(this).attr("href"),"twitter-share-dialog","width=626,height=436"),!1}),hr=$("#facebookshare").attr("href"),hr+="?u="+link,$("#facebookshare").attr("href",hr),$("#facebookshare").click(function(){return window.open($(this).attr("href"),"facebook-share-dialog","width=626,height=436"),!1}),hr=$("#googleshare").attr("href"),hr+="?url="+link,$("#googleshare").attr("href",hr),$("#googleshare").click(function(){return window.open($(this).attr("href"),"google-share-dialog","width=626,height=436"),!1}),hr=$("#identicashare").attr("href"),hr+="&status_textarea="+encodeURIComponent(name+" / "+desc)+link,$("#identicashare").attr("href",hr),$("#identicashare").click(function(){return window.open($(this).attr("href"),"identica-share-dialog","width=626,height=436"),!1})}})}.call(this),function(){{var Agora=this.Agora;this.app}Agora.AuthoritiesListView=Agora.GenericListView.extend({el:"#auth-ul-list",templateEl:"#template-one-authority-item"}),Agora.AvailableAuthoritiesView=Backbone.View.extend({el:"#available-authorities",initialize:function(){_.bindAll(this),this.template=_.template($("#template-available-authorities").html()),this.$el.html(this.template({})),this.auth_list_view=new Agora.AuthoritiesListView}})}.call(this),function(){var AgoraInfiniteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-agora-item",setup:function(){this.converter=new Showdown.converter,Agora.GenericListView.prototype.setup.apply(this)},renderItem:function(model){var json=model.toJSON();return json.short_description=this.converter.makeHtml(json.short_description),this.template(json)}});Agora.AgoraListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new AgoraInfiniteView}})}.call(this),function(){var Agora=this.Agora,app=this.app;Agora.AgoraSettingsFormView=Backbone.View.extend({el:"#agora-settings-form",sendingData:!1,events:{"click .available-choices li a":"selectChoice","click #save_profile":"updateProfile","click #save_configuration":"updateConfiguration","click #save_authorities":"updateAuthorities"},initialize:function(){_.bindAll(this),this.template=_.template($("#template-agora-settings-form").html()),this.templateAuthority=_.template($("#template-authority-item").html()),this.render()},render:function(){var data=ajax_data;data.delegation_status=null==data.agora.delegation_status?{session_id:"-",status:"-",created_at:"-",updated_at:"-",pubkey:"-",director_id:-1}:ajax_data.agora.delegation_status,this.$el.html(this.template(data)),this.$el.find("#id_delegation_policy option").each(function(){$(this).attr("value")==ajax_data.agora.delegation_policy&&$(this).attr("selected","selected")}),1==ajax_data.agora.is_vote_secret&&this.$el.find("#id_is_vote_secret").attr("checked","checked"),this.$el.find("#id_comments_policy option").each(function(){$(this).attr("value")==ajax_data.agora.comments_policy&&$(this).attr("selected","selected")}),this.$el.find("#id_membership_policy option").each(function(){$(this).attr("value")==ajax_data.agora.membership_policy&&$(this).attr("selected","selected")}),1==ajax_data.agora.featured_election&&$("#id_featured_election").attr("checked","checked"),this.$el.find(".available-choices ul").shuffle();var self=this,selection=[];return _.each(ajax_data.agora_authorities.objects,function(element,index){var target=null;self.$el.find(".available-choices ul li").each(function(){$(this).data("id")==element.id&&(target=this)}),selection[index]=target}),_.each(selection,function(element){self.selectChoice({target:element})}),this.delegateEvents(),this},updateData:function(what){if(!this.sendingData){var data=null;if("profile"==what)data={pretty_name:this.$el.find("#id_pretty_name").val(),short_description:this.$el.find("#id_short_description").val(),biography:this.$el.find("#id_biography").val(),is_vote_secret:ajax_data.agora.is_vote_secret,membership_policy:ajax_data.agora.membership_policy,comments_policy:ajax_data.agora.comments_policy,delegation_policy:ajax_data.agora.delegation_policy};else{var is_vote_secret=!1,delegation_policy=this.$el.find("#id_delegation_policy").val();("ALLOW_ENCRYPTED_DELEGATION"==delegation_policy||"ALLOW_SECRET_DELEGATION"==delegation_policy)&&(is_vote_secret=!0),data={pretty_name:ajax_data.agora.pretty_name,short_description:ajax_data.agora.short_description,biography:ajax_data.agora.biography,is_vote_secret:is_vote_secret,featured_election:this.$el.find("#id_featured_election:checked").length>0,membership_policy:this.$el.find("#id_membership_policy").val(),comments_policy:this.$el.find("#id_comments_policy").val(),delegation_policy:delegation_policy}}this.sendingData=!0,this.$el.find("button[type=submit]").addClass("disabled");{var self=this;$.ajax("/api/v1/agora/"+ajax_data.agora.id+"/",{data:JSON.stringifyCompat(data),contentType:"application/json",type:"PUT"}).done(function(){window.location.reload()}).fail(function(){self.sendingData=!1,self.$el.find("button[type=submit]").removeClass("disabled"),alert(gettext("Sorry, error saving agora settings"))})}}},updateProfile:function(e){e.preventDefault(),this.updateData("profile")},updateConfiguration:function(e){e.preventDefault(),this.updateData("configuration")},updateAuthorities:function(e){if(e.preventDefault(),!this.sendingData){var data={action:"set_authorities",authorities_ids:[]};this.$el.find(".user-choices ul li").each(function(){data.authorities_ids=data.authorities_ids.concat([$(this).data("id")])}),this.sendingData=!0,this.$el.find("button[type=submit]").addClass("disabled");{var self=this;$.ajax("/api/v1/agora/"+ajax_data.agora.id+"/action/",{data:JSON.stringifyCompat(data),contentType:"application/json",type:"POST"}).done(function(){window.location.reload()}).fail(function(){self.sendingData=!1,self.$el.find("button[type=submit]").removeClass("disabled"),alert(gettext("Sorry, error saving authorities settings"))})}}},selectChoice:function(e){var newSelection,liEl=$(e.target).closest("li"),id=liEl.data("id"),length=this.$el.find(".user-choices ul li").length;if(_.each(ajax_data.available_authorities.objects,function(element){element.id==id&&(newSelection=element)}),liEl.hasClass("active")){liEl.removeClass("active"),liEl.find("i").addClass("icon-chevron-right"),liEl.find("i").removeClass("icon-chevron-left"),liEl.find("i").removeClass("icon-white");var userChoice=null;this.$el.find(".user-choices ul li").each(function(index){$(this).data("id")==id&&(userChoice=$(this)),userChoice&&$(this).find("small").html(index+".")
}),userChoice.remove(),length-1<ajax_data.max_authorities&&this.$el.find(".cannot-select-more").hide()}else{if(length>=ajax_data.max_authorities)return;liEl.addClass("active"),liEl.find("i").removeClass("icon-chevron-right"),liEl.find("i").addClass("icon-chevron-left"),liEl.find("i").addClass("icon-white");var templData={name:newSelection.name,i:length+1},newChoiceLink=this.templateAuthority(templData),newChoice=$(document.createElement("li"));newChoice.data("id",id),newChoice.html(newChoiceLink),this.$el.find(".user-choices ul").append(newChoice),length+1==ajax_data.min_authorities&&this.$el.find(".need-select-more").hide(),length+1==ajax_data.max_authorities&&this.$el.find(".cannot-select-more").show()}}}),Agora.AgoraSettingsView=Backbone.View.extend({initialize:function(){_.bindAll(this),Agora.renderAgoraTabs(),app.modalDialog=new Agora.ModalDialogView;var text=$("#agora_short_description").text(),converter=new Showdown.converter;$("#agora_short_description").html(converter.makeHtml(text)),this.agora_settings_form_view=new Agora.AgoraSettingsFormView}})}.call(this),function(){var AgoraUserInfiniteView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-agora-profile-item",events:{"click .user-result .row":"clickUser","click .action-send-message":"showSendMessageDialog","click .action-choose-as-delegate":"delegateVote","click .action-edit-name":"editName","click .dropdown-toggle":"toggleDropdown"},filter:function(param){this.url=param?this.$el.data("url")+"?username="+param:this.$el.data("url"),this.collection.reset(),this.firstLoadSuccess=!1,this.finished=!1,this.offset=0,this.requestObjects()},renderItem:function(model){var json=model.toJSON();return json.agora_id=this.$el.data("agora-id"),json.agora_path=this.$el.data("agora-path"),json.initials=Agora.getUserInitials(json),this.template(json)},clickUser:function(e){if(!$(e.target).closest("a")){var url=$(e.target).closest(".row").data("url");window.location.href=url}},toggleDropdown:function(e){console.log("dropdown event");var dropdown=$(e.target).closest(".dropdown-toggle");if(!dropdown.data("permissions")){var json={action:"get_permissions",userid:dropdown.closest(".row").data("id")},self=this;$.ajax("/api/v1/agora/"+ajax_data.agora.id+"/action/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(data){data.agora_path=self.$el.data("agora-path"),data.username=dropdown.closest(".row").data("username"),dropdown.data("permissions",data),data.id=json.userid;var templatePerms=_.template($("#template-agora-profile-permissions").html());dropdown.closest(".dropdown-toggle").next().html(templatePerms(data))})}},delegateVote:function(e){e.preventDefault();var id=this.$el.data("agora-id"),voter=this.collection.get(id).toJSON();$(e.target).closest(".action-choose-as-delegate").data("agora",ajax_data.agora),$(e.target).closest(".action-choose-as-delegate").data("delegate",voter),Agora.delegateVoteHandler(e,this)},editName:function(e){e.preventDefault(),$(e.target).closest(".dropdown").find(".dropdown-toggle").dropdown("toggle");var user_id=$(e.target).closest("div.row.bottom-bordered").data("id"),user_fullname=$(e.target).closest("div.row.bottom-bordered").data("fullname"),username=$(e.target).closest("div.row.bottom-bordered").data("username");user_fullname.length||(user_fullname=username),app.editNameDialog=new Agora.ModalDialogView;var title=interpolate(gettext("Edit %s full name"),[username]),data={user_fullname:user_fullname,username:username},body=_.template($("#template-edit_name_dialog_body").html())(data),footer=_.template($("#template-edit_name_dialog_footer").html())();return app.editNameDialog.populate(title,body,footer),app.editNameDialog.show(),$("#change-name-action").click(function(e){if(e.preventDefault(),!$("#change-name-action").hasClass("disabled")){$("#change-name-action").addClass("disabled");{var json={first_name:$("#user_full_name").val()};$.ajax("/api/v1/user/"+user_id+"/change_name/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(){$("#modal_dialog").modal("hide"),alert(gettext("Name changed successfully")),window.location.reload(!0)}).fail(function(){$("#change-name-action").removeClass("disabled"),alert(gettext("Error saving the name, please try again later"))})}return!1}}),!1},showSendMessageDialog:function(e){e.preventDefault(),$(e.target).closest(".dropdown").find(".dropdown-toggle").dropdown("toggle");var user_id=$(e.target).closest("div.row.bottom-bordered").data("id"),user_fullname=$(e.target).closest("div.row.bottom-bordered").data("fullname");user_fullname.length||(user_fullname=$(e.target).closest("div.row.bottom-bordered").data("username")),app.sendMessageDialog=new Agora.ModalDialogView;var title=interpolate(gettext("Send a message to %s"),[user_fullname]),data={user_fullname:user_fullname},body=_.template($("#template-send_mail_modal_dialog_body").html())(data),footer=_.template($("#template-send_mail_modal_dialog_footer").html())();return app.sendMessageDialog.populate(title,body,footer),app.sendMessageDialog.show(),$("#send-mail-action").click(function(e){if(e.preventDefault(),!$("#send-mail-action").hasClass("disabled")){$("#send-mail-action").addClass("disabled");{var json={comment:$("#mail_content").val()};$.ajax("/api/v1/user/"+user_id+"/send_mail/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(){$("#modal_dialog").modal("hide"),alert(gettext("Mail sent successfully"))}).fail(function(){$("#send-mail-action").removeClass("disabled"),alert(gettext("Error sending the message, please try again later"))})}return!1}}),!1}});Agora.AgoraUserListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new AgoraUserInfiniteView,this.agoraActionListView=new Agora.AgoraActionListView,app.modalDialog=new Agora.ModalDialogView,this.filter="";var obj=this,delay=function(){var timer=0;return function(callback,ms){clearTimeout(timer),timer=setTimeout(callback,ms)}}();$("#filter-input").keyup(function(){delay(function(){obj.filterList()},500)}),$("#filter-input").keypress(function(e){13==e.which&&obj.filterList()}),$("#filter-button").click(function(){obj.filterList()})},filterList:function(){newf=$("#filter-input").val(),this.filter!=newf&&(this.filter=newf,this.infiniteListView.filter(this.filter))}})}.call(this),function(){var Agora=this.Agora,app=this.app;Agora.QuestionListView=Backbone.View.extend({tagName:"div",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-question_list_view").html()),this.render(),this.$el},render:function(){this.$el.html(this.template(ajax_data)),$("#question-list").append(this.$el),$("#question-list table tbody").each(function(){var randomize=$(this).data("randomize");randomize&&$(this).shuffle()})}}),Agora.ElectionResultsView=Backbone.View.extend({tagName:"div",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-election_results_view").html()),this.render(),this.$el},render:function(){this.$el.html(this.template(ajax_data)),$("#election-results").append(this.$el);for(var i=0;i<ajax_data.election.result.counts.length;i++){var view=null;"MEEK-STV"==ajax_data.election.result.counts[i].tally_type?view=new Agora.MeekStvTallyView({question:ajax_data.election.result.counts[i],tally:ajax_data.extra_data.tally_log[i],question_num:i}):"ONE_CHOICE"==ajax_data.election.result.counts[i].tally_type?view=new Agora.OneChoiceTallyView({question:ajax_data.election.result.counts[i],tally:ajax_data.extra_data.tally_log[i],question_num:i}):"APPROVAL"==ajax_data.election.result.counts[i].tally_type&&(view=new Agora.ApprovalTallyView({question:ajax_data.election.result.counts[i],tally:ajax_data.extra_data.tally_log[i],question_num:i})),$("#election-results").append(view.render().el)}}}),Agora.MeekStvTallyView=Backbone.View.extend({tagName:"div",id:function(){return"tally_question"+this.options.question_num},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-question_meek_stv_tally").html()),this.render(),this.$el},render:function(){return this.$el.html(this.template(this.options)),this.$el.find("tbody tr").sortElements(function(a,b){var rate=function(i){return $(i).find(".already_won").length+$(i).find(".won").length-$(i).find(".lost").length-$(i).find(".already_lost").length};return rate(a)<rate(b)}),this}}),Agora.OneChoiceTallyView=Backbone.View.extend({tagName:"div",id:function(){return"tally_question"+this.options.question_num},className:"election-results",initialize:function(){return _.bindAll(this),this.color=d3.scale.category10(),this.template=_.template($("#template-question_one_choice_tally").html()),this.render(),this.$el},render:function(){for(var i=0;i<this.options.question.answers.length;i++)this.options.question.answers[i].color=this.color(i);return this.$el.html(this.template(this.options)),this.$el.find("li").sortElements(function(a,b){var rate=function(i){return parseFloat($(i).data("value"))};return rate(a)<rate(b)}),this.pieChart(),this},pieChart:function(){var pienode=this.$el.find(".piechart")[0];Charts.arc(this.options.question.answers,pienode,function(d){return d.total_count},function(d){return d.value},this.color,500,250)}}),Agora.ApprovalTallyView=Backbone.View.extend({tagName:"div",id:function(){return"tally_question"+this.options.question_num},className:"election-results",initialize:function(){return _.bindAll(this),this.color=d3.scale.category10(),this.template=_.template($("#template-question_approval_tally").html()),this.render(),this.$el},render:function(){for(var i=0;i<this.options.question.answers.length;i++)this.options.question.answers[i].color=this.color(i);return this.$el.html(this.template(this.options)),this.$el.find("li").sortElements(function(a,b){var rate=function(i){return parseFloat($(i).data("value"))};return rate(a)<rate(b)}),this.pieChart(),this},pieChart:function(){var pienode=this.$el.find(".piechart")[0];Charts.arc(this.options.question.answers,pienode,function(d){return d.total_count},function(d){return d.value},this.color,500,250)}}),Agora.ElectionView=Backbone.View.extend({el:"div.election",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView),this.questionListView=new Agora.QuestionListView,ajax_data.election.tally_released_at_date&&(this.electionResultsView=new Agora.ElectionResultsView)}}),Agora.ElectionDelegatesView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-vote_list_item",templateVoteInfoEl:"#template-vote_info",templateVoteInfo:null,sendingData:!1,events:{"hover .user-result .row":"hoverUser"},initialize:function(){Agora.GenericListView.prototype.initialize.apply(this),this.delegateView=null,this.init_filter()},init_filter:function(){this.filter="";var obj=this,delay=function(){var timer=0;return function(callback,ms){clearTimeout(timer),timer=setTimeout(callback,ms)}}();$("#filter-input").keyup(function(){delay(function(){obj.filterList()},500)}),$("#filter-input").keypress(function(e){13==e.which&&obj.filterList()}),$("#filter-button").click(function(){obj.filterList()})},filterList:function(){newf=$("#filter-input").val(),this.filter!=newf&&(this.filter=newf,this.filterf(this.filter))},filterf:function(param){this.url=param?this.$el.data("url")+"?username="+param:this.$el.data("url"),this.collection.reset(),this.firstLoadSuccess=!1,this.finished=!1,this.offset=0,this.requestObjects()},renderItem:function(model){return this.template(model.toJSON())},hoverUser:function(e){this.templateVoteInfo||(this.templateVoteInfo=_.template($(this.templateVoteInfoEl).html()));{var id=$(e.target).closest(".row").data("id"),self=this;ajax_data.election.agora}self.delegate="ALLOW_DELEGATION"==ajax_data.election.agora.delegation_policy;var model={vote:this.collection.get(id).toJSON(),election:ajax_data.election,delegation:self.delegate,extra_data:ajax_data.extra_data};if(model.election.tally_released_at_date&&(model.num_delegated_votes=0,model.rank_in_delegates="-",model.vote.delegate_election_count)){model.num_delegated_votes=model.vote.delegate_election_count.count;var rank=model.vote.delegate_election_count.rank;rank&&(model.rank_in_delegates=rank+"º")}$("#vote_info").html(this.templateVoteInfo(model)),1==self.delegate&&$("#vote_info .delegate_vote").click(this.delegateVote)},delegateVote:function(e){e.preventDefault(),Agora.delegateVoteHandler(e,this)}}),Agora.FeaturedElectionView=Backbone.View.extend({el:"#content-wrapper",initialize:function(){_.bindAll(this),app.modalDialog=new Agora.ModalDialogView,this.bw_template=_.template($("#template_background-wrapper-featured-election").html()),this.question_template=_.template($("#template_featured-election-question").html()),this.question_primary_template=_.template($("#template_featured-election-primary-question").html()),this.oc_question_template=_.template($("#template_featured-election-tallied-one-choice-question").html()),this.stv_question_template=_.template($("#template_featured-election-tallied-stv-question").html());var data=ajax_data;if(data.is_demo=window.location.href.lastIndexOf("/demo")>=window.location.href.length-6,$("#background-wrapper-fe").html(this.bw_template(ajax_data)),ajax_data.election.tally_released_at_date)for(var i=0;i<ajax_data.election.questions.length;i++){var data={i:i,q:ajax_data.election.result.counts[i],q_tally:ajax_data.extra_data.tally_log[i]};if("PRIMARY"==data.q.layout)$("#bloques").append(this.question_primary_template(data)),$("#q"+i+" table.question-stv tbody tr").sortElements(function(a,b){var rate=function(i){return $(i).find(".already_won").length+$(i).find(".won").length-$(i).find(".lost").length-$(i).find(".already_lost").length};return rate(a)<rate(b)}),$(".candidates-list.list-"+i+" .candidate").sortElements(function(a,b){return $(a).data("pos")>$(b).data("pos")});else if("question/result/ONE_CHOICE"==data.q.a)$("#bloques").append(this.oc_question_template(data));else{var el=this.stv_question_template(data);$("#bloques").append(el),$("#q"+i+" table.question-stv tbody tr").sortElements(function(a,b){var rate=function(i){return $(i).find(".already_won").length+$(i).find(".won").length-$(i).find(".lost").length-$(i).find(".already_lost").length};return rate(a)<rate(b)})}}else for(var i=0;i<ajax_data.election.questions.length;i++){var data={i:i,q:ajax_data.election.questions[i]};"PRIMARY"==data.q.layout?($("#bloques").append(this.question_primary_template(data)),data.q.randomize_answer_order&&$(".candidates-list.list-"+i).shuffle()):$("#bloques").append(this.question_template(data))}1==ajax_data.election.questions.length&&$("#q0").addClass("in"),$("a.cand-details").click(this.showDetails)},showDetails:function(e){e.preventDefault();var i=$(e.target).data("question-index"),j=$(e.target).data("option-index"),answer=ajax_data.election.questions[i].answers[j],title=answer.value,bodyTmpl=_.template($("#template-show_option_details_body").html()),body=bodyTmpl(answer),footer='<button type="button" class="btn btn-warning" data-dismiss="modal" aria-hidden="true">'+gettext("Close")+"</button>";app.modalDialog.populate(title,body,footer),app.modalDialog.show()}}),Agora.ElectionSecurityCenterView=Backbone.View.extend({el:"#election-security-center",initialize:function(){this.template=_.template($("#template-election-security-center").html()),this.$el.html(this.template(ajax_data))}})}.call(this),function(){var ElectionInfinteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-election-item",renderItem:function(model){var json=model.toJSON();return json.election_at=interpolate(gettext("%(electionname)s at %(agora_full_name)s"),{electionname:json.pretty_name,agora_full_name:json.agora.full_name},!0),this.template(json)}});Agora.ElectionListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new ElectionInfinteView}})}.call(this),function(){{var Agora=this.Agora;this.app}(function(){var SearchInfiniteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-item",converter:null,setup:function(){this.converter=new Showdown.converter,Agora.GenericListView.prototype.setup.apply(this),this.params={q:this.$el.data("query")},this.templates={},ctypes=["agora","election","profile"];for(var i=0;i<ctypes.length;i++){var templateEl="#template-search-"+ctypes[i]+"-item";this.templates[ctypes[i]]=_.template($(templateEl).html())}},renderItem:function(model){var ctype=(this.templateEl,model.get("obj").content_type),template=this.templates[ctype],json=model.toJSON().obj;"profile"==ctype?json.initials=Agora.getUserInitials(json):"election"==ctype?json.election_at=interpolate(gettext("%(electionname)s at %(agora_full_name)s"),{electionname:json.pretty_name,agora_full_name:json.agora.full_name},!0):"agora"==ctype&&(json.short_description=this.converter.makeHtml(json.short_description));var ret=template(json);return ret}});Agora.SearchListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new SearchInfiniteView}})}).call(this)}.call(this),function(){{var Agora=this.Agora;this.app}Agora.TalliedUserElectionsView=Backbone.View.extend({el:"#tallied_user_elections_view",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-tallied_user_elections_view").html()),this.render(),this.$el},render:function(){for(var i=0;i<ajax_data.tallied_elections.objects.length;i++){var election=ajax_data.tallied_elections.objects[i];if(election.result&&(election.result.is_simple=!1,election.result.participation_percentage=Agora.round2decimals(100*election.result.total_votes/election.result.electorate_count),1==election.result.counts.length&&"question/result/ONE_CHOICE"==election.result.counts[0].a))for(var winner=election.result.counts[0].winners[0],answers=election.result.counts[0].answers,j=0;j<answers.length;j++)if(answers[j].value==winner){election.result.winner_data=answers[j],election.result.winner_data.total_count_percentage=Agora.round2decimals(election.result.winner_data.total_count_percentage),election.result.is_simple=!0;break}}var data=ajax_data.tallied_elections;return data.user=ajax_data.user,this.$el.html(this.template(data)),this.delegateEvents(),this}}),Agora.UserDelegateInActionsView=Backbone.View.extend({el:"#user_delegate_in_actions",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-user_delegate_in_actions").html()),this.render(),this.$el},render:function(){if($("body").data("userid")!=ajax_data.user.id){var data={agoras:_.filter(ajax_data.user_agoras.objects,function(agora){return-1!=_.indexOf(agora.agora_permissions,"delegate")}),user:ajax_data.user};return this.$el.html(this.template(data)),this.$(".delegate_vote").click(this.delegateVote),this.delegateEvents(),this}},delegateVote:function(e){e.preventDefault(),Agora.delegateVoteHandler(e,this)}}),Agora.UserView=Backbone.View.extend({el:"div.user",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView),this.tallied_user_elections_view=new Agora.TalliedUserElectionsView,this.user_agoras_list_view=new Agora.UserAgorasListView({show_other:!0}),this.user_delegate_in_actions_view=new Agora.UserDelegateInActionsView,$(".participated_elections_badge").html(ajax_data.tallied_elections.meta.total_count)}})}.call(this),function(){var Agora=this.Agora,app=this.app;Agora.UserSettingsFormView=Backbone.View.extend({el:"#user-settings-form",events:{"click #set_gravatar_mugshot":"setGravatarMugshot","click #set_initials_mugshot":"setInitialsMugshot"},initialize:function(){_.bindAll(this),this.template=_.template($("#template-user-settings-form").html()),this.render();var metrics_profile=[["#id_first_name","presence",gettext("This field is required")],["#id_first_name","between:4:140",gettext("Must be between 4 and 140 characters long")]];this.$el.find("#tab-profile form").nod(metrics_profile,{silentSubmit:!0,broadcastError:!0}),this.$el.find("#tab-profile form").on("silentSubmit",this.saveProfile),this.$el.find("#tab-profile form").submit(function(e){e.preventDefault()});var metrics_email=[["#id_email","email",gettext("Must be a valid email (RFC 822)")]];this.$el.find("#email_form").nod(metrics_email,{silentSubmit:!0,broadcastError:!0}),this.$el.find("#email_form").on("silentSubmit",this.saveEmail),this.$el.find("#email_form").submit(function(e){e.preventDefault()});var metrics_password=[["#id_password1","presence",gettext("This field is required")],["#id_password2","presence",gettext("This field is required")],["#id_password1","min-length:4",gettext("At least 4 characters")],["#id_password2","same-as:#id_password1",gettext("Your passwords do not match")]];this.$el.find("#password_form").nod(metrics_password,{silentSubmit:!0,broadcastError:!0}),this.$el.find("#password_form").on("silentSubmit",this.savePassword),this.$el.find("#password_form").submit(function(e){e.preventDefault()});var lang=$("body").data("lang"),lang_name=$("#id_language li[data-langcode="+lang+"] a").html();$("#id_language .current-item.inline").html(lang_name),$("#uploaded-avatar").change(function(){var file=this.files[0];if(name=file.name,size=file.size,type=file.type,!file.type.match(/image.*/)||size>102400)return void alert("Not an image or too big");var formdata=!1;if(window.FormData&&(formdata=new FormData),window.FileReader&&(reader=new FileReader,reader.readAsDataURL(file)),formdata){formdata.append("custom_avatar",file);var self=this;$.ajax("/api/v1/user/mugshot/",{type:"POST",data:formdata,processData:!1,contentType:!1}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,alert("Error uploading mugshot")})}});var metrics_username=[["#id_username","presence",gettext("This field is required")],["#id_username","between:4:140",gettext("Must be between 4 and 140 characters long")]];return this.$el.find("#username_form").nod(metrics_username,{silentSubmit:!0,broadcastError:!0}),this.$el.find("#username_form").on("silentSubmit",this.changeUsername),this.$el.find("#username_form").submit(function(e){e.preventDefault()}),$("#remove_account_btn").click(this.removeAccount),this.$el},sendingData:!1,setGravatarMugshot:function(e){if(e.preventDefault(),!this.sendingData){$(".btn[type=submit]").addClass("disabled"),this.sendingData=!0;{var json={use_gravatar:!0},self=this;$.ajax("/api/v1/user/settings/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,$(".btn[type=submit]").removeClass("disabled"),alert("Error saving profile settings")})}return!1}},setInitialsMugshot:function(e){if(e.preventDefault(),!this.sendingData){$(".btn[type=submit]").addClass("disabled"),this.sendingData=!0;{var json={use_initials:!0},self=this;$.ajax("/api/v1/user/settings/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,$(".btn[type=submit]").removeClass("disabled"),alert("Error saving profile settings")})}return!1}},saveProfile:function(e){if(e.preventDefault(),!this.sendingData){$(".btn[type=submit]").addClass("disabled"),this.sendingData=!0;{var json={first_name:$("#id_first_name").val(),short_description:$("#id_short_description").val(),biography:$("#id_biography").val(),username:$("#id_username").val()},self=this;$.ajax("/api/v1/user/settings/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,$(".btn[type=submit]").removeClass("disabled"),alert("Error saving profile settings")})}return!1}},saveEmail:function(e){if(e.preventDefault(),!this.sendingData){$(".btn[type=submit]").addClass("disabled"),this.sendingData=!0;{var json={email:$("#id_email").val(),email_updates:"checked"==$("#id_email_updates").attr("checked"),old_password:$("#id_current_password2").val()},self=this;$.ajax("/api/v1/user/settings/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,$(".btn[type=submit]").removeClass("disabled"),alert(gettext("Error saving email settings. Please check that the provided current pasword is valid. Or maybe the email the provided email is invalid or already in use."))})}return!1}},savePassword:function(e){if(e.preventDefault(),!this.sendingData){$(".btn[type=submit]").addClass("disabled"),this.sendingData=!0;{var json={old_password:$("#id_current_password").val(),password1:$("#id_password1").val(),password2:$("#id_password2").val()},self=this;$.ajax("/api/v1/user/settings/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,$(".btn[type=submit]").removeClass("disabled"),alert("Error saving password settings. Please check that the provided current pasword is valid.")})}return!1}},changeUsername:function(e){if(e.preventDefault(),!this.sendingData){var data={username:ajax_data.user.username};app.confirmChangeUsernameDialog=new Agora.ModalDialogView;var title=_.template($("#template-confirm_change_username_modal_dialog_title").html())(),body=_.template($("#template-confirm_change_username_modal_dialog_body").html())(),footer=_.template($("#template-confirm_change_username_modal_dialog_footer").html())(),title2=_.template($("#template-confirm_change_username_modal_dialog_title2").html())(),body2=_.template($("#template-confirm_change_username_modal_dialog_body2").html())(data),footer2=_.template($("#template-confirm_change_username_modal_dialog_footer2").html())();return app.confirmChangeUsernameDialog.populate(title,body,footer),app.confirmChangeUsernameDialog.show(),$("#confirm-change-username-action").click(function(e){return e.preventDefault(),$("#modal-label").html(title2),$(".modal-body").html(body2),$(".modal-footer").html(footer2),$("#do-change-username-action").click(function(e,self){if(e.preventDefault(),$("#do-change-username-action").hasClass("disabled"))return!1;$("#do-change-username-action").addClass("disabled"),this.sendingData=!0;{var json={username:$("#id_username_modal_dialog").val()},self=this;$.ajax("/api/v1/user/settings/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(){self.sendingData=!1,$("#do-change-username-action").removeClass("disabled"),$("#modal_dialog").modal("hide")}).fail(function(){self.sendingData=!1,$("#do-change-username-action").removeClass("disabled"),alert("Error changing username"),$("#modal_dialog").modal("hide")})}return!1}),!1}),!1}},removeAccount:function(e){if(e.preventDefault(),!this.sendingData){app.confirmRemoveAccountDialog=new Agora.ModalDialogView;var title=_.template($("#template-remove_account_modal_dialog_title").html())(),body=_.template($("#template-remove_account_modal_dialog_body").html())(),footer=_.template($("#template-remove_account_modal_dialog_footer").html())();app.confirmRemoveAccountDialog.populate(title,body,footer),app.confirmRemoveAccountDialog.show();var self=this;return $("#confirm-remove-account-action").click(function(e){e.preventDefault(),self.sendingData=!0;{var json={password:$("#remove_account_password").val()};$.ajax("/api/v1/user/disable/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(){window.location.reload(!0)}).fail(function(){self.sendingData=!1,alert("Error, possibly an invalid password")})}return!1}),!1}},render:function(){return this.$el.html(this.template(ajax_data.user)),this.delegateEvents(),this}}),Agora.UserSettingsView=Backbone.View.extend({initialize:function(){_.bindAll(this),this.user_settings_form_view=new Agora.UserSettingsFormView}})}.call(this),function(){var UserInfiniteView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-search-profile-item",renderItem:function(model){var json=model.toJSON();return json.initials=Agora.getUserInitials(json),this.template(json)}});Agora.UserListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new UserInfiniteView}})}.call(this),function(){Agora.AnswerModel=Backbone.AssociatedModel.extend({defaults:{a:"ballot/answer",urls:[],details:"",value:"",media_url:"",details_title:""}}),Agora.QuestionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"answers",relatedModel:Agora.AnswerModel}],defaults:{a:"ballot/question",tally_type:"ONE_CHOICE",layout:"SIMPLE",question_num:0,max:1,min:0,num_seats:1,question:"",randomize_answer_order:!0,answers:[]}}),Agora.ElectionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"questions",relatedModel:Agora.QuestionModel}],defaults:{pretty_name:"",description:"",security_policy:"PUBLIC_VOTING",questions:[],from_date:"",to_date:"",release_tally_automatically:!0}}),Agora.AnswerView=Backbone.View.extend({tagName:"tr",events:{"click td":"editValue","keyup .input-edit-value":"keyUpSaveValue"},initialize:function(){return _.bindAll(this),this.render(),this.listenTo(this.model,"destroy",this.remove),this.$el},render:function(){return this.template=_.template($("#template-election_form_question_answer").html()),this.$el.html(this.template(this.model.toJSON())),this.$el.find(".input-edit-value").focusout(this.focusOutValue),this},editValue:function(e){if(!$(e.target).hasClass("remove_option")){var val=this.$el.find(".the-value").html();this.$el.find(".input-edit-value").val(val),this.$el.find(".view-value").hide(),this.$el.find(".edit-value").show(),this.$el.find(".input-edit-value").focus()}},keyUpSaveValue:function(e){if(13==e.keyCode){var value=this.$el.find(".input-edit-value").val();if(!value)return this.$el.find(".view-value").show(),void this.$el.find(".edit-value").hide();this.model.set("value",value),this.$el.find(".the-value").html(value),this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide()}else 27==e.keyCode&&(this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide())},focusOutValue:function(){this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide()}}),Agora.QuestionEditView=Backbone.View.extend({tagName:"div",className:"tab-pane",events:{"click .dropdown-menu li a":"selectVotingSystem","click .add_option_btn":"userAddAnswer","keyup .add_option":"userAddAnswerEnter","click .remove_option":"userRemoveAnswer","click .create_question_btn":"createQuestion"},getMetrics:function(){var self=this,checkNumWinners=function(val){var num_answers=self.model.get("answers").length;return 2>num_answers?!0:num_answers>val},checkMax=function(val){var num_answers=self.model.get("answers").length;return 2>num_answers?!0:num_answers>val},checkNumAnswers=function(){var num_answers=self.model.get("answers").length;return num_answers>=2};return[[".name","presence",gettext("This field is required")],[".name","min-length:4",gettext("Must have at least 4 characters")],[".num_winners","presence",gettext("This field is required")],[".min_num_choices","presence",gettext("This field is required")],[".max_num_choices","presence",gettext("This field is required")],[".num_winners","integer",gettext("This field must be an integer")],[".min_num_choices","integer",gettext("This field must be an integer")],[".max_num_choices","integer",gettext("This field must be an integer")],[".num_winners",checkNumWinners,gettext("Invalid value")],[".min_num_choices",checkMax,gettext("Invalid value")],[".add_option",checkNumAnswers,gettext("Add at least two choices")]]},id:function(){return"question-tab-"+this.model.get("question_num")},updateModel:function(){this.model.set("question",this.$el.find(".name").val()),this.model.set("num_seats",parseInt(this.$el.find(".num_winners").val())),this.model.set("min",parseInt(this.$el.find(".min_num_choices").val())),this.model.set("max",parseInt(this.$el.find(".max_num_choices").val()))
},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-election_form_question_tab_pane").html()),this.model.questionView=this,this.render(),this.listenTo(this.model.get("answers"),"add",this.addAnswer),this.listenTo(this.model.get("answers"),"remove",this.removeAnswer),this.listenTo(this.model.get("answers"),"reset",this.resetAnswers),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change:question_num",this.render),this.listenTo(this.model.get("answers"),"change:value",this.answerChanged),this.$el},render:function(){var json=this.model.toJSON();json.edit_election=ajax_data?!0:!1,this.$el.html(this.template(json)),this.$el.attr("id",this.id);var self=this;return this.$el.find(".votingsystem-dropdown li").each(function(){var id=$(this).data("id");if(id==self.$el.find(".votingsystem").data("id")){var usertext=$(this).data("usertext");self.$el.find(".votingsystem").html(usertext),"MEEK-STV"==id||"APPROVAL"==id?self.$el.find(".num_winners_opts").css("display","inline-block"):(self.$el.find(".num_winners_opts").hide(),self.$el.find(".max_num_choices").attr("readonly","readonly"))}}),this.resetAnswers(),this.$el.find("form").nod(this.getMetrics(),{silentSubmit:!0,broadcastError:!0,submitBtnSelector:".hidden-input"}),this.$el.find("form").submit(function(e){e.preventDefault()}),this},userRemoveAnswer:function(e){var value=$(e.target).closest("a").data("value"),model=this.model.get("answers").find(function(answer){return answer.get("value")==value});this.model.get("answers").remove(model),model.destroy()},userAddAnswerEnter:function(e){return e.preventDefault(),e.stopPropagation(),13==e.keyCode&&this.userAddAnswer(),!1},userAddAnswer:function(){var val=this.$el.find(".add_option").val();if(val){var model=this.model.get("answers").find(function(answer){return answer.get("value")==val});if(!model){this.$el.find(".add_option").val("");var newAnswer=new Agora.AnswerModel({value:val});this.model.get("answers").add(newAnswer)}}},addAnswer:function(answerModel){var view=new Agora.AnswerView({model:answerModel});this.$el.find(".option-list").append(view.render().el),this.model.get("answers").length>0&&this.$el.find(".atleastwooptions").hide()},removeAnswer:function(){this.model.get("answers").length<1&&this.$el.find(".atleastwooptions").show()},answerChanged:function(answer){var answers=this.model.get("answers").filter(function(answer2){return answer.get("value")==answer2.get("value")});answers.length>1&&answer.destroy()},resetAnswers:function(){this.$el.find(".option-list").empty(),this.model.get("answers").each(this.addAnswer)},resetForm:function(){this.stopListening(),this.model.clear().set(this.model.defaults),this.initialize()},selectVotingSystem:function(e){var id=$(e.target).closest("li").data("id"),usertext=$(e.target).closest("li").data("usertext");this.$el.find(".votingsystem").data("id",id),this.$el.find(".votingsystem").html(usertext),"MEEK-STV"==id||"APPROVAL"==id?(this.$el.find(".num_winners_opts").css("display","inline-block"),this.$el.find(".max_num_choices").removeAttr("readonly")):(this.$el.find(".num_winners_opts input").val("1"),this.$el.find(".num_winners_opts").hide(),this.$el.find(".max_num_choices").val("1"),this.$el.find(".max_num_choices").attr("readonly","readonly")),this.model.set("tally_type",id)},createQuestion:function(){if(this.$el.find("form").nod().formIsErrorFree()){this.updateModel();var model=this.model.clone();model.set("question_num",app.currentView.model.get("questions").length+1),app.currentView.model.get("questions").add(model),this.resetForm()}}}),Agora.ElectionCreateForm=Backbone.View.extend({el:"div.top-form",initData:{},__initialLoading:!1,getMetrics:function(){var self=this,checkIntervalDate=function(){if(0==self.$el.find("#schedule_voting:checked").length)return!0;var val_end=self.$el.find("#end_voting_date").val(),end_date=moment(val_end,"MM/DD/YYYY HH:mm"),val_start=self.$el.find("#start_voting_date").val(),start_date=moment(val_start,"MM/DD/YYYY HH:mm");return null!=end_date&&null!=start_date&&end_date-start_date>=36e5};return[["#pretty_name","presence",gettext("This field is required")],["#pretty_name","min-length:4",gettext("Must have at least 4 characters")],["#description","presence",gettext("This field is required")],["#description","min-length:4",gettext("Must be at least 4 characters long")],["#start_voting_date",checkIntervalDate,gettext("Invalid dates")],["#end_voting_date",checkIntervalDate,gettext("Invalid dates")]]},events:{"click #schedule_voting":"toggleScheduleVoting","click #show_add_question_tab_btn":"showAddQuestionTab","click #schedule_voting_label":"checkSchedule","click .remove_question_btn":"removeQuestion","click .create_election_btn":"saveElection","click .create_election2_btn":"saveElection2"},getInitModel:function(){return new Agora.ElectionModel},modelToJsonForTemplate:function(){var json=this.model.toJSON();return json.edit_election=!1,json},initialize:function(){var log_error=function(event,data){console.log(data.el),console.log(data.msg)};$(window).on("nod_error_fired",log_error),this.template=_.template($("#template-election_form").html()),this.templateNavtab=_.template($("#template-election_form_question_navtab").html()),_.bindAll(this),this.model=this.getInitModel();var dataModel=this.modelToJsonForTemplate();dataModel.languages=user_data.languages,this.$el.html(this.template(dataModel)),this.addQuestionView=new Agora.QuestionEditView({model:new Agora.QuestionModel({question_num:0}),electionFormView:this}),this.$el.find(".tab-content").append(this.addQuestionView.render().el),this.listenTo(this.model.get("questions"),"add",this.addQuestion),this.__initialLoading=!0,this.model.get("questions").each(this.addQuestion),this.__initialLoading=!1;var self=this;this.$el.find("#id_voting_policy option").each(function(){$(this).attr("value")==self.model.get("security_policy")&&$(this).attr("selected","selected")}),this.model.get("release_tally_automatically")&&$("#release_tally_automatically").attr("checked","checked"),this.listenTo(this.model,"change",this.updateButtonsShown),this.listenTo(this.model.get("questions"),"add",this.updateButtonsShown),this.listenTo(this.model.get("questions"),"remove",this.updateButtonsShown),this.updateButtonsShown(),this.$el.find("#create_election_form").nod(this.getMetrics(),{silentSubmit:!0,submitBtnSelector:".hidden-input"}),this.$el.find("form").submit(function(e){e.preventDefault()}),$(".datetimepicker").datetimepicker(),this.model.get("from_date")&&"Invalid date"!=this.model.get("from_date")&&(this.$el.find("#schedule_voting").click(),$("div.top-form #schedule_voting_controls").toggle())},removeQuestion:function(e){var question_num=$(e.target).data("id"),question=this.model.get("questions").at(question_num-1),length=this.model.get("questions").length;question.destroy(),this.model.get("questions").remove(question),this.$el.find("#question-navtab-"+length).remove();var i=1;this.model.get("questions").each(function(model){model.set("question_num",i),i++});var selector="#add-question-navtab a";this.$el.find(selector).tab("show")},checkSchedule:function(e){0==$("#schedule_voting:checked").length&&$(e.target).closest(".error").removeClass("error")},addQuestion:function(questionModel){var i=questionModel.get("question_num"),newTab=this.templateNavtab({question_num:i});this.$el.find("#add-question-navtab").before(newTab);var view=new Agora.QuestionEditView({model:questionModel,electionFormView:this});this.$el.find(".tab-content").append(view.render().el),this.__initialLoading||$("#question-navtab-"+i+" a").tab("show")},toggleScheduleVoting:function(e){$("div.top-form #schedule_voting_controls").toggle(e.target.checked)},updateModel:function(){this.model.set("release_tally_automatically",$("#release_tally_automatically:checked").length>0);var start_date=this.$el.find("#start_voting_date").val(),end_date=this.$el.find("#end_voting_date").val();0==$("#schedule_voting:checked").length?(this.model.set("from_date",""),this.model.set("to_date","")):(this.model.set("from_date",new Date(start_date).toJSON()),this.model.set("to_date",new Date(end_date).toJSON())),this.model.set("pretty_name",this.$el.find("#pretty_name").val()),this.model.set("description",this.$el.find("#description").val()),this.model.set("short_description",this.model.get("description").substr(0,140)),this.model.set("security_policy",this.$el.find("#id_security_policy").val())},sendingData:!1,saveElection:function(e){if(e.preventDefault(),!this.sendingData&&($("#main-election-tab").hasClass("active")||$("#main-election-tab a").tab("show"),this.$el.find("#create_election_form").nod().formIsErrorFree())){this.updateModel();var failingQuestion=this.model.get("questions").find(function(question){return question.questionView.updateModel(),!question.questionView.$el.find("form").nod().formIsErrorFree()});if(failingQuestion){var question_num=failingQuestion.get("question_num"),selector="#question-navtab-"+question_num+" a";return void this.$el.find(selector).tab("show")}$(".create_election_btn").addClass("disabled"),this.sendingData=!0;var json=this.model.toJSON();json.action="create_election";{var agora_id=$("#agora_id").val(),self=this;$.ajax("/api/v1/agora/"+agora_id+"/action/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(e){window.location.href=e.url}).fail(function(e){self.sendingData=!1,$(".create_election_btn").removeClass("disabled");var response=$.parseJSON(e.responseText);alert(response.errors?response.errors.__all__:gettext("Error creating the election"))})}return!1}},saveElection2:function(e){if(e.preventDefault(),!this.sendingData){$(".create_election_btn").addClass("disabled"),this.sendingData=!0;var json=JSON.parse($("#raw-text").val());json.action="create_election";{var agora_id=$("#agora_id").val(),self=this;$.ajax("/api/v1/agora/"+agora_id+"/action/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(e){window.location.href=e.url}).fail(function(e){self.sendingData=!1,$(".create_election2_btn").removeClass("disabled");var response=$.parseJSON(e.responseText);alert(response.errors?response.errors.__all__:gettext("Error creating the election"))})}return!1}},updateButtonsShown:function(){0==this.model.get("questions").length?(this.$el.find(".create_election_btn").hide(),this.$el.find("#save_election_btn").hide(),this.$el.find("#show_add_question_tab_btn").show()):(this.$el.find(".create_election_btn").show(),this.$el.find("#save_election_btn").show(),this.$el.find("#show_add_question_tab_btn").hide())},showAddQuestionTab:function(){this.$el.find(".nav-tabs a:last").tab("show")}}),Agora.ElectionEditForm=Agora.ElectionCreateForm.extend({getInitModel:function(){var from_date=moment(ajax_data.voting_starts_at_date),to_date=moment(ajax_data.voting_ends_at_date);from_date&&(from_date=from_date.format("MM/DD/YYYY HH:mm")),to_date&&(to_date=to_date.format("MM/DD/YYYY HH:mm"));var initData={id:ajax_data.id,pretty_name:ajax_data.pretty_name,description:ajax_data.description,comments_policy:ajax_data.comments_policy,security_policy:ajax_data.security_policy,questions:ajax_data.questions,from_date:from_date,to_date:to_date,release_tally_automatically:ajax_data.release_tally_automatically};return new Agora.ElectionModel(initData)},modelToJsonForTemplate:function(){var json=this.model.toJSON();return json.edit_election=ajax_data?!0:!1,json},sendingData:!1,saveElection:function(e){if(e.preventDefault(),!this.sendingData&&this.$el.find("#create_election_form").nod().formIsErrorFree()){this.updateModel();var failingQuestion=this.model.get("questions").find(function(question){return question.questionView.updateModel(),!question.questionView.$el.find("form").nod().formIsErrorFree()});if(failingQuestion){var question_num=failingQuestion.get("question_num"),selector="#question-navtab-"+question_num+" a";return void this.$el.find(selector).tab("show")}this.$el.find("#save_election_btn").addClass("disabled"),this.sendingData=!0;var json=this.model.toJSON();json.from_date&&(json.from_date=new Date(json.from_date).toJSON()),json.to_date&&(json.to_date=new Date(json.to_date).toJSON());{var election_id=this.model.get("id"),self=this;$.ajax("/api/v1/election/"+election_id+"/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(e){window.location.href=e.url}).fail(function(){alert("Error saving the election")}).always(function(){self.sendingData=!1,self.$el.find("#save_election_btn").removeClass("disabled")})}return!1}}})}.call(this),function(){Agora.VoteAnswerModel=Backbone.AssociatedModel.extend({defaults:{a:"ballot/answer",urls:[],details:"",value:"",media_url:"",details_title:""}}),Agora.checkWebWorkersAvailable=function(){return"undefined"!=typeof Worker},Agora.emailChecker=function(v){var RFC822;return RFC822=/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*$/,RFC822.test(v)},Agora.encryptAnswer=function(pk_json,encoded_answer,randomness){var pk=ElGamal.PublicKey.fromJSONObject(pk_json),plaintext=new ElGamal.Plaintext(encoded_answer,pk,!0);randomness=randomness?BigInt.fromJSONObject(randomness):Random.getRandomInteger(pk.q);var ctext=ElGamal.encrypt(pk,plaintext,randomness),proof=plaintext.proveKnowledge(ctext.alpha,randomness,ElGamal.fiatshamir_dlog_challenge_generator),ciphertext=ctext.toJSONObject(),json_proof=proof.toJSONObject(),enc_answer={alpha:ciphertext.alpha,beta:ciphertext.beta,commitment:json_proof.commitment,response:json_proof.response,challenge:json_proof.challenge};return enc_answer},Agora.VoteQuestionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"answers",relatedModel:Agora.VoteAnswerModel},{type:Backbone.Many,key:"user_answers",relatedModel:Agora.VoteAnswerModel}],defaults:{a:"ballot/question",tally_type:"ONE_CHOICE",question_num:0,max:1,min:0,num_seats:1,question:"",randomize_answer_order:!0,answers:[],user_answers:[]}}),Agora.VoteElectionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"questions",relatedModel:Agora.VoteQuestionModel}],defaults:{pretty_name:"",description:"",security_policy:"PUBLIC_VOTING",user_vote_is_secret:!0,questions:[],from_date:"",to_date:""},initialize:function(){var self=this;this.get("questions").each(function(element,index,list){element.set("question_num",index),element.set("num_questions",list.length),element.set("election_name",self.get("pretty_name"))})}}),Agora.VotingBooth=Backbone.View.extend({el:"#voting_booth",events:{"click .btn-start-voting":"startVoting","click #user_vote_is_public":"toggleWhy"},is_tokenized:!1,jsonFromURL:function(){for(var query=decodeURI(document.location.search.substr(1)),data=query.split("&"),result={},i=0;i<data.length;i++){var item=data[i].split("=");result[item[0]]=decodeURIComponent(item[1])}return result},reviewMode:!1,initialize:function(){if(_.bindAll(this),this.template=_.template($("#template-voting_booth").html()),this.templateEncrypting=_.template($("#template-voting_booth_encrypting").html()),"True"==AGORA_USE_AUTH_TOKEN_VALIDATION){var json_url=this.jsonFromURL();json_url.message&&json_url.sha1_hmac&&(this.is_tokenized=!0,this.json_url=json_url,ajax_data.is_tokenized=!0)}return ajax_data.has_to_authenticate=has_to_authenticate,this.model=new Agora.VoteElectionModel(ajax_data),this.render(),this.$el},render:function(){var data=this.model.toJSON();data.is_tokenized=this.is_tokenized,data.DEFAULT_FROM_EMAIL=DEFAULT_FROM_EMAIL,this.$el.html(this.template(data)),this.questionViews=[];var self=this;return this.model.get("questions").each(function(element,index){self.questionViews[index]=self.createQuestionView(element)}),this.reviewQuestions=new Agora.ReviewQuestionsView({model:this.model,votingBooth:this}),this.voteCast=new Agora.VoteCastView({model:this.model,votingBooth:this}),"True"!=AGORA_USE_AUTH_TOKEN_VALIDATION||this.is_tokenized?this.is_tokenized?this.startVoting():(this.startScreenView=new Agora.VotingBoothStartScreen({model:this.model}),this.$el.find(".current-screen").append(this.startScreenView.render().el)):document.location=AGORA_TOKEN_REDIRECT_IDENTIFY_URL,this.delegateEvents(),this},createQuestionView:function(model){var voting_system=model.get("tally_type"),layout=model.get("layout");return"ONE_CHOICE"==voting_system?new Agora.VotePluralityQuestion({model:model,votingBooth:this}):"MEEK-STV"==voting_system||"APPROVAL"==voting_system?"PRIMARY"==layout?new Agora.VotePrimaryMultiQuestion({model:model,votingBooth:this,system:voting_system}):new Agora.VoteMultiQuestion({model:model,votingBooth:this,system:voting_system}):void 0},startVoting:function(){this.$el.find(".current-screen").html(""),this.$el.find(".current-screen").append(this.questionViews[0].render().el)},nextStep:function(question_num){var size=this.model.get("questions").length;return this.$el.find(".current-screen").html(""),question_num+1==size||this.reviewMode?(this.reviewMode=!0,void this.$el.find(".current-screen").append(this.reviewQuestions.render().el)):void this.$el.find(".current-screen").append(this.questionViews[question_num+1].render().el)},changeQuestionChoices:function(question_num){this.$el.find(".current-screen").html(""),this.$el.find(".current-screen").append(this.questionViews[question_num].render().el)},sendingData:!1,toggleWhy:function(){var user_vote_is_secret=0==this.$el.find("#user_vote_is_public:checked").length;user_vote_is_secret?$("#why_id").hide():$("#why_id").show()},castVote:function(){if(!this.sendingData){this.sendingData=!0;var user_vote_is_encrypted="ALLOW_ENCRYPTED_VOTING"==ajax_data.security_policy;user_vote_is_encrypted&&(this.$el.find(".current-screen").html(""),this.$el.find(".current-screen").html(this.templateEncrypting(this.model.toJSON())));var user_vote_is_secret=0==this.$el.find("#user_vote_is_public:checked").length;if(this.ballot={is_vote_secret:user_vote_is_secret,action:"vote"},!user_vote_is_secret){var why=$("#why_id").val();this.ballot.reason=why}var self=this;if(this.model.get("questions").each(function(element,index){var user_answers=element.get("user_answers").pluck("value"),voting_system=element.get("tally_type");"ONE_CHOICE"==voting_system?self.ballot["question"+index]=user_answers.length>0?user_answers[0]:"":("MEEK-STV"==voting_system||"APPROVAL"==voting_system)&&(self.ballot["question"+index]=user_answers)}),user_vote_is_encrypted)this.nextquestionToEncryptIndex=0,$("html").attr("style","height: 100%; cursor: wait !important;"),setTimeout(this.encryptNextQuestion,300);else{var random=sjcl.random.randomWords(5,0),rand_bi=new BigInt(sjcl.codec.hex.fromBits(random),16);this.ballot.unique_randomness=rand_bi.toRadix(16),this.eventVoteSealed()}}},encryptNextQuestion:function(){if(this.nextquestionToEncryptIndex>=ajax_data.questions.length)return void this.eventVoteSealed();var index=this.nextquestionToEncryptIndex;this.nextquestionToEncryptIndex=index+1;var data=this.questionViews[index].encodeQuestionAnswer(this.ballot["question"+index]),decoded_data=this.questionViews[index].decodeQuestionAnswer(data),decoded_data_str=JSON.stringifyCompat(decoded_data),ballot_str=JSON.stringifyCompat(this.ballot["question"+index]);if(ballot_str!=decoded_data_str)return alert(gettext("Sorry, but the codification of the vote failed. This is most likely a problem with your web browser. Please contact us telling information about what web browser and platform are you using to vote. We will redirect you now to the contact form.")),void(window.location.href="/contact");var percent_num=parseInt(100*(index+1)/ajax_data.questions.length,10);this.ballot.issue_date=moment().format(),this.ballot["question"+index]=Agora.encryptAnswer(ajax_data.pubkeys[index],data);var percent=interpolate("width: %s%;",[percent_num]);$("#encrypt_progress").attr("style",percent),$("#encrypt_progress").html(""+percent_num+"%"),setTimeout(this.encryptNextQuestion,200)},eventVoteSealed:function(){return $("html").attr("style",""),!this.is_tokenized&&has_to_authenticate?void this.showAuthenticationForm():void this.sendBallot()},showAuthenticationForm:function(){return"yes-please"==$("#vote_fake").data("fakeit")?(this.$el.find(".current-screen").html(""),void this.$el.find(".current-screen").append(this.voteCast.render().el)):(this.authenticateFormView=new Agora.AuthenticateFormView({model:this.model,votingBooth:this}),this.$el.find(".current-screen").html(""),void this.$el.find(".current-screen").append(this.authenticateFormView.render().el))},sendBallot:function(){var election_id=this.model.get("id");if(this.is_tokenized&&(this.ballot.action="token_vote",this.ballot.message=this.json_url.message,this.ballot.sha1_hmac=this.json_url.sha1_hmac),"yes-please"==$("#vote_fake").data("fakeit"))return ajax_data.ballot=this.ballot,this.$el.find(".current-screen").html(""),void this.$el.find(".current-screen").append(this.voteCast.render().el);{var self=this;$.ajax("/api/v1/election/"+election_id+"/action/",{data:JSON.stringifyCompat(self.ballot),contentType:"application/json",type:"POST"}).done(function(){ajax_data.ballot=self.ballot,self.$el.find(".current-screen").html(""),self.$el.find(".current-screen").append(self.voteCast.render().el)}).fail(function(jqXHR){self.sendingData=!1,self.$el.find("#cast-ballot-btn").removeClass("disabled"),-1!=jqXHR.responseText.indexOf("validation")?(alert(gettext("There was a problem casting the ballot, your SMS code has expired and is no longer valid. To vote, you need to identify yourself again. Redirecting to the home page.")),document.location.href=AGORA_TOKEN_REDIRECT_IDENTIFY_URL):-1!=jqXHR.responseText.indexOf("token")||ajax_data.is_tokenized?(alert(gettext("There was a problem casting the ballot. Maybe you already voted? You can only vote once. Redirecting to the home page.")),document.location.href=AGORA_TOKEN_REDIRECT_IDENTIFY_URL):alert(gettext("Error casting the ballot, try again or report this problem"))})}},showVoteSent:function(data){this.voteCast.is_counted=data.is_counted,this.$el.find(".current-screen").html(""),this.$el.find(".current-screen").append(this.voteCast.render().el)}}),Agora.VotingBoothStartScreen=Backbone.View.extend({initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_start_screen").html()),this.$el},render:function(){var data=this.model.toJSON();data.vote_isfake="yes-please"==$("#vote_fake").data("fakeit"),data.is_tokenized=ajax_data.is_tokenized,this.$el.html(this.template(data));var converter=new Showdown.converter,self=this;return this.$el.find(".markdown-readonly").each(function(){var data_id=$(this).data("id");$(this).html(converter.makeHtml(self.model.get(data_id))),$(this).find("a").attr("target","_blank")}),this.delegateEvents(),this}}),Agora.VotePluralityQuestion=Backbone.View.extend({events:{"click input":"selectChoice","click .remove-selection":"removeSelection","click .btn-continue":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_question_plurality").html()),this.votingBooth=this.options.votingBooth,this.sanityChecks(),this.$el},sanityChecks:function(){var user_vote_is_encrypted="ALLOW_ENCRYPTED_VOTING"==ajax_data.security_policy;if(user_vote_is_encrypted)try{for(var question=this.model.toJSON(),possible_answers=_.pluck(question.answers,"value"),i=0;10>i;i++){var rnd=Math.ceil(1e4*Math.random())%possible_answers.length,opt=possible_answers[rnd],ballot=opt,encoded=this.encodeQuestionAnswer(ballot),decoded=this.decodeQuestionAnswer(encoded);if(ballot!=decoded)throw"error"}var encoded=this.encodeQuestionAnswer(""),decoded=this.decodeQuestionAnswer(encoded);if(""!=decoded)throw"error"}catch(e){alert(gettext("Sorry, but we have detected errors when doing some sanity automatic checks which prevents to assure that you can vote with this web browser. This is most likely a problem with your web browser. Please contact us telling information about what web browser and platform are you using to vote. We will redirect you now to the contact form.")),window.location.href="/contact"}},render:function(){if(this.$el.html(this.template(this.model.toJSON())),this.$el.find("a").attr("target","_blank"),this.model.get("randomize_answer_order")&&this.$el.find(".plurality-options").shuffle(),this.model.get("user_answers").length>0){var currentSelection=this.model.get("user_answers").at(0).get("value");this.$el.find("label input").each(function(){$(this).val()==currentSelection&&($(this).attr("checked","checked"),$(this).closest("label").addClass("active"))})}return this.delegateEvents(),this},selectChoice:function(e){this.$el.find("label.active").removeClass("active"),$(e.target).closest("label").addClass("active"),this.$el.find(".select-info").hide();var newSelection,value=$(e.target).val();this.model.get("answers").each(function(element){element.get("value")==value&&(newSelection=element.clone())}),this.model.get("user_answers").length>0&&this.model.get("user_answers").at(0).destroy(),this.model.get("user_answers").add(newSelection)},removeSelection:function(e){e.preventDefault(),this.$el.find("label.active input").prop("checked",!1),this.$el.find("label.active").removeClass("active"),this.model.get("user_answers").length>0&&this.model.get("user_answers").at(0).destroy()},continueClicked:function(){return 0==this.model.get("min")?void this.nextStep():0==this.$el.find("label.active").length?void this.$el.find(".select-info").show():void this.nextStep()},encodeQuestionAnswer:function(data){var question=this.model.toJSON(),possible_answers=_.pluck(question.answers,"value"),choice_index=_.indexOf(possible_answers,data);return-1==choice_index&&(choice_index=possible_answers.length+1),BigInt.fromInt(choice_index)},decodeQuestionAnswer:function(encoded_data){var question=this.model.toJSON(),possible_answers=_.pluck(question.answers,"value"),encoded_str=encoded_data.toJSONObject(),encoded_index=parseInt(encoded_str,10);return encoded_index==possible_answers.length+1?"":possible_answers[encoded_index]},nextStep:function(){this.votingBooth.nextStep(this.model.get("question_num"))}}),Agora.VoteMultiQuestion=Backbone.View.extend({events:{"click .available-choices li a":"selectChoice","click .btn-continue":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_question_ranked").html()),this.system=this.options.system,this.templateChoice=_.template("APPROVAL"==this.system?$("#template-voting_booth_question_approval_choice").html():$("#template-voting_booth_question_ranked_choice").html()),this.votingBooth=this.options.votingBooth,this.sanityChecks(),this.$el},sanityChecks:function(){var user_vote_is_encrypted="ALLOW_ENCRYPTED_VOTING"==ajax_data.security_policy;if(user_vote_is_encrypted)try{for(var question=this.model.toJSON(),possible_answers=_.pluck(question.answers,"value"),i=0;10>i;i++){for(var ballot=[],n_selected_options=Math.ceil(1e4*Math.random())%possible_answers.length,j=0;n_selected_options>j;j++){var rnd=Math.ceil(1e4*Math.random())%possible_answers.length,opt=possible_answers[rnd];-1==_.indexOf(ballot,opt)&&ballot.push(opt)}var encoded=this.encodeQuestionAnswer(ballot),decoded=JSON.stringifyCompat(this.decodeQuestionAnswer(encoded));if(JSON.stringifyCompat(ballot)!=decoded)throw"error"}var encoded=this.encodeQuestionAnswer([]),decoded=JSON.stringifyCompat(this.decodeQuestionAnswer(encoded));if(JSON.stringifyCompat([])!=decoded)throw"error"}catch(e){alert(gettext("Sorry, but we have detected errors when doing some sanity automatic checks which prevents to assure that you can vote with this web browser. This is most likely a problem with your web browser. Please contact us telling information about what web browser and platform are you using to vote. We will redirect you now to the contact form.")),window.location.href="/contact"}},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$el.find("a").attr("target","_blank"),this.model.get("randomize_answer_order")&&this.$el.find(".available-choices ul").shuffle();var self=this,selection=[];return this.model.get("user_answers").each(function(element,index){var value=element.get("value"),target=null;self.$el.find(".available-choices ul li").each(function(){$(this).data("value")==value&&(target=this)}),selection[index]=target}),this.model.get("user_answers").reset(),_.each(selection,function(element){self.selectChoice({target:element})}),this.delegateEvents(),this},continueClicked:function(){var length=this.model.get("user_answers").length;return length<this.model.get("min")?void this.$el.find(".need-select-more").show():void this.nextStep()},selectChoice:function(e){var newSelection,liEl=$(e.target).closest("li"),value=liEl.data("value"),length=this.model.get("user_answers").length;if(this.model.get("answers").each(function(element){element.get("value")==value&&(newSelection=element.clone())}),liEl.hasClass("active")){liEl.removeClass("active"),liEl.find("i").addClass("icon-chevron-right"),liEl.find("i").removeClass("icon-chevron-left"),liEl.find("i").removeClass("icon-white");var userChoice=null;this.$el.find(".user-choices ul li").each(function(index){$(this).data("value")==value&&(userChoice=$(this)),userChoice&&$(this).find("small").html(index+".")}),userChoice.remove(),this.model.get("user_answers").each(function(element){element.get("value")==value&&element.destroy()}),length-1<this.model.get("max")&&this.$el.find(".cannot-select-more").hide()}else{if(length>=this.model.get("max"))return;liEl.addClass("active"),liEl.find("i").removeClass("icon-chevron-right"),liEl.find("i").addClass("icon-chevron-left"),liEl.find("i").addClass("icon-white");var templData={value:value,i:length+1},newChoiceLink=this.templateChoice(templData),newChoice=$(document.createElement("li"));newChoice.data("value",value),newChoice.html(newChoiceLink),this.$el.find(".user-choices ul").append(newChoice),this.model.get("user_answers").add(newSelection),length+1==this.model.get("min")&&this.$el.find(".need-select-more").hide(),length+1==this.model.get("max")&&this.$el.find(".cannot-select-more").show()}},encodeQuestionAnswer:function(data){var question=this.model.toJSON(),possible_answers=_.pluck(question.answers,"value"),ret_data="",numChars=(possible_answers.length+2).toString(10).length;_.each(data,function(element){var choice_index=_.indexOf(possible_answers,element);ret_data+=Agora.numberToString(choice_index+1,numChars)}),0==ret_data.length&&(ret_data=Agora.numberToString(possible_answers.length+2,numChars));var ret_val=new BigInt(ret_data,10);return ret_val},decodeQuestionAnswer:function(encoded_data){var question=this.model.toJSON(),possible_answers=_.pluck(question.answers,"value"),encoded_str=encoded_data.toJSONObject(),tab_nchars=(possible_answers.length+2).toString(10).length;if(parseInt(encoded_str,10)==possible_answers.length+2)return[];for(var length=encoded_str.length,missing_zeros=(tab_nchars-length%tab_nchars)%tab_nchars,i=0;missing_zeros>i;i++)encoded_str="0"+encoded_str;for(var ret_val=[],i=0;i<encoded_str.length/tab_nchars;i++){var option_str=encoded_str.substr(i*tab_nchars,tab_nchars),option_index=parseInt(option_str,10),opt_str=possible_answers[option_index-1];ret_val.push(opt_str)}return ret_val},nextStep:function(){this.votingBooth.nextStep(this.model.get("question_num"))}}),Agora.VotePrimaryMultiQuestion=Agora.VoteMultiQuestion.extend({events:{"click .available-choices li a.choose-option":"selectChoice","click .user-choices ul li a":"deselectUserChoice","click .btn-continue":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_question_ranked_primary").html()),this.system=this.options.system,this.templateChoice=_.template("APPROVAL"==this.system?$("#template-voting_booth_question_approval_choice").html():$("#template-voting_booth_question_ranked_choice").html()),this.votingBooth=this.options.votingBooth,app.modalDialog=new Agora.ModalDialogView,this.sanityChecks(),this.$el
},render:function(){this.$el.html(this.template(this.model.toJSON())),this.model.get("randomize_answer_order")&&this.$el.find(".available-choices ul").shuffle();var self=this,selection=[];return this.model.get("user_answers").each(function(element,index){var value=element.get("value"),target=null;self.$el.find(".available-choices ul li").each(function(){$(this).data("value")==value&&(target=this)}),selection[index]=target}),this.model.get("user_answers").reset(),_.each(selection,function(element){self.selectChoice({target:element})}),this.delegateEvents(),setTimeout(self.addFiltering,500),this},addFiltering:function(){var self=this;$("img.img-lazyload").lazyload({container:$(".available-choices ul")}),$("#filter-options").keyup(function(){clearTimeout($.data(this,"timer"));var wait=setTimeout(self.filterOptions,500);$(this).data("timer",wait)}),$("a.option-link").click(function(e){e.preventDefault();var answer,liEl=$(e.target).closest("li"),value=liEl.data("value");self.model.get("answers").each(function(element){element.get("value")==value&&(answer=element.toJSON())});var title=answer.value,bodyTmpl=_.template($("#template-show_option_details_body").html()),body=bodyTmpl(answer),footer='<button type="button" class="btn btn-warning" data-dismiss="modal" aria-hidden="true">'+gettext("Close")+"</button>";app.modalDialog.populate(title,body,footer),app.modalDialog.show()})},filterOptions:function(){var val=$("#filter-options").val().toLowerCase();this.$el.find("ul.primary-options > li").each(function(){var value=$(this).data("value").toLowerCase();-1!=value.indexOf(val)?$(this).show():$(this).hide()}),$("img.img-lazyload").lazyload({container:$(".available-choices ul")})},continueClicked:function(){var length=this.model.get("user_answers").length;return length<this.model.get("min")?void this.$el.find(".need-select-more").show():void this.nextStep()},selectChoice:function(e){e&&e.preventDefault&&e.preventDefault();var newSelection,liEl=$(e.target).closest("li"),value=liEl.data("value"),length=this.model.get("user_answers").length;if(this.model.get("answers").each(function(element){element.get("value")==value&&(newSelection=element.clone())}),liEl.hasClass("active")){liEl.removeClass("active");var userChoice=null;this.$el.find(".user-choices ul li").each(function(index){$(this).data("value")==value&&(userChoice=$(this)),userChoice&&$(this).find("small").html(index+".")}),userChoice.remove(),this.model.get("user_answers").each(function(element){element.get("value")==value&&element.destroy()}),length-1<this.model.get("max")&&this.$el.find(".cannot-select-more").hide()}else{if(length>=this.model.get("max"))return void $("html").scrollTop($(document).height());liEl.addClass("active");var templData={value:value,i:length+1},newChoiceLink=this.templateChoice(templData),newChoice=$(document.createElement("li"));newChoice.data("value",value),newChoice.html(newChoiceLink),this.$el.find(".user-choices ul").append(newChoice),this.model.get("user_answers").add(newSelection),length+1==this.model.get("min")&&this.$el.find(".need-select-more").hide(),length+1==this.model.get("max")&&this.$el.find(".cannot-select-more").show()}},deselectUserChoice:function(e){e.preventDefault();var model,liEl=$(e.target).closest("li"),value=liEl.data("value"),length=this.model.get("user_answers").length;this.model.get("answers").each(function(element){element.get("value")==value&&(model=element.clone())}),this.$el.find(".available-choices ul li").each(function(){var availableChoice;$(this).data("value")==value&&(availableChoice=$(this),availableChoice.removeClass("active"))}),liEl.remove(),this.model.get("user_answers").each(function(element){element.get("value")==value&&element.destroy()}),this.$el.find(".user-choices ul li").each(function(index){$(this).find("small").html(index+1+".")}),length-1<this.model.get("max")&&this.$el.find(".cannot-select-more").hide()},nextStep:function(){this.votingBooth.nextStep(this.model.get("question_num"))}}),Agora.numberToString=function(number,numChars){for(var num_str=number.toString(10),ret=num_str,i=0;i<numChars-num_str.length;i++)ret="0"+ret;return ret},Agora.ReviewQuestionsView=Backbone.View.extend({events:{"click th a":"changeQuestionChoices","click #cast-ballot-btn":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_review_questions").html()),this.votingBooth=this.options.votingBooth,this.$el},render:function(){var data=this.model.toJSON();this.$el.html(this.template(data)),this.delegateEvents();var is_fake="yes-please"==$("#vote_fake").data("fakeit");return"DISALLOW_DELEGATION"==ajax_data.agora.delegation_policy&&"PUBLIC_VOTING"!=this.model.get("security_policy")?(this.$el.find("#user_vote_is_public").parent().hide(),this.$el.find("#why_id").hide()):is_fake||has_to_authenticate||-1!=this.model.get("user_perms").indexOf("vote_counts")&&"PUBLIC_VOTING"!=this.model.get("security_policy")?this.$el.find("#why_id").hide():(this.$el.find("#user_vote_is_public").attr("checked","checked"),this.$el.find("#user_vote_is_public").attr("disabled",!0),this.$el.find("#user_vote_is_public").hide(),this.$el.find("#user_vote_is_public").closest("label").find("span.optional").hide(),this.$el.find("#user_vote_is_public").closest("label").find("span.mandatory").removeClass("hide"),this.$el.find(".mainlabel").hide()),this},changeQuestionChoices:function(e){this.votingBooth.changeQuestionChoices($(e.target).data("id"))},continueClicked:function(){this.votingBooth.castVote()}}),Agora.AuthenticateFormView=Backbone.View.extend({events:{"click a#loginAndVote":"loginAndVote","click a#fnmtLoginAndVote":"fnmtLoginAndVote","click a#registerAndVote":"registerAndVote"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_auth_screen").html()),this.votingBooth=this.options.votingBooth,this.$el},sendingData:!1,render:function(){return this.$el.html(this.template(this.model.toJSON())),this.delegateEvents(),this.$el.find("#login_vote_form").nod(this.getLoginFormMetrics(),{silentSubmit:!0,broadcastError:!0,submitBtnSelector:".hidden-input"}),this.$el.find("#login_vote_form").submit(function(e){e.preventDefault()}),this.$el.find("#register_vote_form").nod(this.getRegisterFormMetrics(),{silentSubmit:!0,broadcastError:!0,submitBtnSelector:".hidden-input"}),this.$el.find("#register_vote_form").submit(function(e){e.preventDefault()}),this},getLoginFormMetrics:function(){var checkEmailOrName=function(val){var username_rx=/^[a-zA-Z0-9-_]+$/;return Agora.emailChecker(val)||username_rx.test(val)};return[["#id_identification","presence",gettext("This field is required")],["#id_identification","min-length:3",gettext("Must have at least 3 characters")],["#id_identification",checkEmailOrName,gettext("Invalid value")],["#id_password","presence",gettext("This field is required")]]},getRegisterFormMetrics:function(){var checkPass=function(val){return val==$("#id_password1").val()},checkScannedId=function(){return void 0!=$("#id_scanned_id").get(0).files[0]};return[["#id_first_name","presence",gettext("This field is required")],["#id_username","presence",gettext("This field is required")],["#id_username","min-length:3",gettext("Must have at least 3 characters")],["#id_email","presence",gettext("This field is required")],["#id_email","email",gettext("Invalid email")],["#id_password1","presence",gettext("This field is required")],["#id_password2","presence",gettext("This field is required")],["#id_password1","min-length:3",gettext("Must have at least 3 characters")],["#id_password2",checkPass,gettext("Passwords do not match")],["#id_scanned_id",checkScannedId,gettext("Attached a file")]]},startSendingData:function(){this.sendingData=!0,this.$el.find(".btn-large").addClass("disabled")},stopSendingData:function(){this.sendingData=!1,this.$el.find(".btn-large").removeClass("disabled")},loginAndVote:function(){if(this.$el.find("#login_vote_form").nod().formIsErrorFree()){var ballot=this.votingBooth.ballot;ballot.action="login_and_vote",ballot.issue_date=moment().format(),ballot.user_id=this.$el.find("#id_identification").val(),ballot.password=this.$el.find("#id_password").val();var user_vote_is_encrypted="ALLOW_ENCRYPTED_VOTING"==ajax_data.security_policy;if(!user_vote_is_encrypted){var random=sjcl.random.randomWords(5,0),rand_bi=new BigInt(sjcl.codec.hex.fromBits(random),16);ballot.unique_randomness=rand_bi.toRadix(16)}this.startSendingData();{var self=this,election_id=this.model.get("id");$.ajax("/api/v1/election/"+election_id+"/action/",{data:JSON.stringifyCompat(ballot),contentType:"application/json",type:"POST"}).done(function(data){self.stopSendingData(),ajax_data.ballot=ballot,self.votingBooth.showVoteSent(data)}).fail(function(){self.stopSendingData(),alert(gettext("Error casting the ballot. The given username probably doesn't exist. Try again or report this problem."))})}}},email_address:!1,fnmtLoginAndVote:function(){var self=this,url=AGORA_FNMT_BASE_URL+"/user/login/fnmt/";this.email_address&&(url=url+"?email="+this.email_address),this.startSendingData(),$.ajax({type:"GET",url:url,dataType:"jsonp",timeout:1e6,success:function(json){if(json.needs_email)if(self.email_address)alert(gettext("We are having trouble with your FNMT certificate. We recomend you to login from the web site front page and then try to vote again. Sorry for the inconvenience.")),window.location.href="/";else{for(var email="",i=0;!Agora.emailChecker(email)&&2>i;)email=window.prompt(gettext("Your FNMT certificate doesn't provide us an email address. Please, provide us your email address:"),"email@example.com"),email||(alert(gettext("We are having trouble with your FNMT certificate. We recomend you to login from the web site front page and then try to vote again. Sorry for the inconvenience.")),window.location.href="/"),i+=1;self.email_address=email,self.fnmtLoginAndVote()}else self.stopSendingData(),self.votingBooth.sendBallot()},error:function(){self.stopSendingData()}})},registerAndVote:function(){if(this.$el.find("#register_vote_form").nod().formIsErrorFree()){var ballot=this.votingBooth.ballot;ballot.action="register_and_vote",ballot.issue_date=moment().format(),ballot.user_id=this.$el.find("#id_identification").val(),ballot.password=this.$el.find("#id_password").val(),this.startSendingData();var self=this,election_id=this.model.get("id");ballot.election_id=election_id,$("#id_ballot_data").attr("value",JSON.stringifyCompat(ballot));var user_vote_is_encrypted="ALLOW_ENCRYPTED_VOTING"==ajax_data.security_policy;if(!user_vote_is_encrypted){var random=sjcl.random.randomWords(5,0),rand_bi=new BigInt(sjcl.codec.hex.fromBits(random),16);ballot.unique_randomness=rand_bi.toRadix(16)}{$.ajax("/accounts/signup_and_vote/",{type:"POST",data:new FormData($("#register_vote_form")[0]),cache:!1,contentType:!1,processData:!1}).done(function(data){self.stopSendingData(),ajax_data.ballot=ballot,self.votingBooth.showVoteSent(data)}).fail(function(){self.stopSendingData(),alert(gettext("Error casting the ballot. The given username might already exist or the attached file is too big. Try again or report this problem."))})}}}}),Agora.VoteCastView=Backbone.View.extend({events:{},is_counted:!0,initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_vote_cast").html()),this.votingBooth=this.options.votingBooth,this.$el},render:function(){var data=this.model.toJSON();if(data.ballot_hash=Agora.hashBallot(ajax_data.ballot),ajax_data.ballot_hash=data.ballot_hash,data.is_counted=this.is_counted,data.return_to_election=AGORA_FRONT_PAGE!=ajax_data.agora.full_name,data.is_tokenized="True"==AGORA_USE_AUTH_TOKEN_VALIDATION,data.share_url=AGORA_TOKEN_REDIRECT_IDENTIFY_URL,data.return_to_election||(data.url="/"),this.$el.html(this.template(data)),this.delegateEvents(),ajax_data.is_tokenized)try{history.pushState({},$("title").html(),"/")}catch(e){}return this}}),Agora.jsonStringifySorted=function(obj){if(Array.isArray(obj)){for(var serialized=[],i=0;i<obj.length;i++)serialized.push(Agora.jsonStringifySorted(obj[i]));return"["+serialized.join(", ")+"]"}if("object"==typeof obj){if(null==obj)return"null";for(var sortedKeys=Object.keys(obj).sort(),arr=[],i=0;i<sortedKeys.length;i++){var key=sortedKeys[i],value=obj[key];key=JSON.stringify(key),value=Agora.jsonStringifySorted(value),arr.push(key+": "+value)}return"{"+arr.join(", ")+"}"}return JSON.stringify(obj)},Agora.hashBallot=function(ballot){for(var transformedBallot={a:"encrypted-vote-v1",proofs:[],choices:[],issue_date:ballot.issue_date,election_hash:{a:"hash/sha256/value",value:ajax_data.hash},election_uuid:ajax_data.uuid},i=0;i<ajax_data.questions.length;i++){var q_answer=ballot["question"+i];transformedBallot.proofs.push({commitment:q_answer.commitment,response:q_answer.response,challenge:q_answer.challenge}),transformedBallot.choices.push({alpha:q_answer.alpha,beta:q_answer.beta})}var str_data=Agora.jsonStringifySorted(transformedBallot),bitArray=sjcl.hash.sha256.hash(str_data);return sjcl.codec.hex.fromBits(bitArray)}}.call(this);